<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style> main { padding: 20px; } </style>
</head>
<body>
    <div id="topRightControls" style="position: absolute; top: 1rem; right: 1rem; z-index: 10; display: flex; gap: 8px; align-items: center;">
        <button class="contrast" onclick="logout()">Logout</button>
        <button onclick="goBack()">Back to Dashboard</button>
        <!-- Theme toggle will be injected here -->
    </div>
    <main class="container">
        <h1 style="text-align:center;">User Management</h1>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
            <input id="searchInput" type="text" placeholder="Search users..." style="max-width: 250px;">
            <div id="pagination" style="display: flex; gap: 8px;"></div>
        </div>
        <div class="overflow-auto">
            <table id="userTable">
                <thead><tr><th>Username</th><th>Role</th><th>Carrier</th><th><input type="checkbox" id="selectAll"></th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top: 1em;">
            <button id="bulkDeleteBtn" class="contrast outline" style="display:none;">Delete Selected</button>
        </div>
        <p id="feedback" style="text-align:center; min-height: 20px;"></p>
    </main>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:2000; align-items:center; justify-content:center;">
        <div id="modalContent" style="background:#fff; color:#222; padding:2em; border-radius:8px; min-width:300px; max-width:90vw; box-shadow:0 2px 16px rgba(0,0,0,0.2);"></div>
    </div>
    <div id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#222; color:#fff; padding:12px 24px; border-radius:24px; z-index:3000; font-size:1rem; min-width:120px; text-align:center;"></div>

    <script>
        // ...existing code...
        // --- Theme management ---
        const THEME_KEY = 'dsim_theme';
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            addThemeToggle();
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
        }
        function addThemeToggle() {
            if (document.getElementById('themeToggleBtn')) return;
            const toggle = document.createElement('button');
            toggle.className = 'theme-toggle';
            toggle.id = 'themeToggleBtn';
            toggle.innerHTML = `<span>üåì</span><span>Theme</span>`;
            toggle.onclick = toggleTheme;
            const controls = document.getElementById('topRightControls');
            if (controls) {
                controls.appendChild(toggle);
            } else {
                document.body.appendChild(toggle);
            }
        }
        // --- Loading overlay ---
        function showLoading() { document.querySelector('.loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.querySelector('.loading-overlay').style.display = 'none'; }
        // --- Toasts ---
        function showToast(msg, isError) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.background = isError ? '#c0392b' : '#222';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2500);
        }
        // --- Modal ---
        function showModal(html, onConfirm, onCancel) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            content.innerHTML = html + `<div style='margin-top:1em; text-align:right;'><button id='modalOk'>OK</button> <button id='modalCancel'>Cancel</button></div>`;
            modal.style.display = 'flex';
            document.getElementById('modalOk').onclick = () => { modal.style.display = 'none'; if (onConfirm) onConfirm(); };
            document.getElementById('modalCancel').onclick = () => { modal.style.display = 'none'; if (onCancel) onCancel(); };
        }
        // --- Pagination ---
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        const PAGE_SIZE = 10;
        // --- Bulk selection ---
        let selectedUsers = new Set();
        // --- Main logic ---
        sessionToken = "<?= token ?>";
        function logout() {
            showLoading();
            google.script.run
                .withSuccessHandler(() => {
                    document.querySelector('main').innerHTML = '<h1>You have been logged out.</h1>';
                    hideLoading();
                })
                .withFailureHandler(() => { hideLoading(); })
                .logoutUser({token: sessionToken});
        }
        function goBack() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(html) {
                    document.open(); document.write(html); document.close();
                })
                .withFailureHandler(() => { hideLoading(); })
                .getAdminPageHtml(sessionToken);
        }
        function loadUsers() {
            showLoading();
            document.getElementById('feedback').innerText = 'Loading users...';
            google.script.run
                .withSuccessHandler(response => {
                    allUsers = response;
                    filteredUsers = allUsers;
                    currentPage = 1;
                    renderTable();
                    hideLoading();
                })
                .withFailureHandler(function(err) {
                    document.getElementById('feedback').innerText = 'Error loading users: ' + err.message;
                    showToast('Error loading users', true);
                    hideLoading();
                })
                .getAllUsers({token: sessionToken});
        }
        function renderTable() {
            const userTableBody = document.querySelector('#userTable tbody');
            userTableBody.innerHTML = '';
            const start = (currentPage-1)*PAGE_SIZE;
            const pageUsers = filteredUsers.slice(start, start+PAGE_SIZE);
            pageUsers.forEach(user => {
                const checked = selectedUsers.has(user.username) ? 'checked' : '';
                userTableBody.innerHTML += `<tr>
                    <td>${user.username}</td>
                    <td><select onchange="inlineEditRole('${user.username}', this.value)" style="min-width:90px;">${['Admin','Driver','Load Support'].map(r=>`<option value='${r}' ${user.role===r?'selected':''}>${r}</option>`).join('')}</select></td>
                    <td><input type="text" value="${user.carrier||''}" style="min-width:90px;" onchange="inlineEditCarrier('${user.username}', this.value)"></td>
                    <td><input type="checkbox" class="rowSelect" data-username="${user.username}" ${checked}></td>
                    <td>
                        <button class="secondary outline" onclick="resetPassword('${user.username}')" title="Reset Password">üîë</button>
                        <button class="contrast outline" onclick="deleteUser('${user.username}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            document.getElementById('feedback').innerText = '';
            updatePagination();
            updateBulkDeleteBtn();
            // Keyboard navigation
            Array.from(document.querySelectorAll('#userTable input, #userTable select, #userTable button')).forEach(el => {
                el.onkeydown = function(e) {
                    if (e.key === 'Enter') e.target.blur();
                };
            });
        }
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / PAGE_SIZE) || 1;
            const pagDiv = document.getElementById('pagination');
            pagDiv.innerHTML = '';
            for (let i=1; i<=totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i===currentPage ? 'secondary' : '';
                btn.onclick = () => { currentPage = i; renderTable(); };
                pagDiv.appendChild(btn);
            }
        }
        function updateBulkDeleteBtn() {
            const btn = document.getElementById('bulkDeleteBtn');
            btn.style.display = selectedUsers.size > 0 ? '' : 'none';
        }
        // --- Inline editing ---
        function inlineEditRole(username, newRole) {
            showLoading();
            google.script.run
                .withSuccessHandler(() => {
                    showToast('Role updated');
                    loadUsers();
                })
                .withFailureHandler(err => {
                    showToast('Error updating role', true);
                    hideLoading();
                })
                .adminEditUser({token: sessionToken, username, role: newRole, carrier: getCarrier(username)});
        }
        function inlineEditCarrier(username, newCarrier) {
            showLoading();
            google.script.run
                .withSuccessHandler(() => {
                    showToast('Carrier updated');
                    loadUsers();
                })
                .withFailureHandler(err => {
                    showToast('Error updating carrier', true);
                    hideLoading();
                })
                .adminEditUser({token: sessionToken, username, role: getRole(username), carrier: newCarrier});
        }
        function getRole(username) {
            const row = Array.from(document.querySelectorAll('#userTable tbody tr')).find(tr => tr.cells[0].textContent === username);
            return row ? row.querySelector('select').value : '';
        }
        function getCarrier(username) {
            const row = Array.from(document.querySelectorAll('#userTable tbody tr')).find(tr => tr.cells[0].textContent === username);
            return row ? row.querySelector('input[type=text]').value : '';
        }
        // --- Reset password ---
        function resetPassword(username) {
            showModal(`Enter a new password for <b>${username}</b>:<br><input type='password' id='newPassInput' style='width:100%;margin-top:0.5em;'>`, function() {
                const newPassword = document.getElementById('newPassInput').value;
                if (!newPassword) { showToast('Password required', true); return; }
                showLoading();
                google.script.run
                    .withSuccessHandler(() => { showToast('Password reset'); loadUsers(); })
                    .withFailureHandler(err => { showToast('Error resetting password', true); hideLoading(); })
                    .adminResetPassword({token: sessionToken, username, newPassword});
            });
        }
        // --- Delete user ---
        function deleteUser(username) {
            showModal(`Are you sure you want to permanently delete <b>${username}</b>?`, function() {
                showLoading();
                google.script.run
                    .withSuccessHandler(() => { showToast('User deleted'); loadUsers(); })
                    .withFailureHandler(err => { showToast('Error deleting user', true); hideLoading(); })
                    .adminDeleteUser({token: sessionToken, username});
            });
        }
        // --- Bulk delete ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('bulkDeleteBtn').onclick = function() {
                showModal(`Delete <b>${selectedUsers.size}</b> selected users?`, function() {
                    showLoading();
                    const users = Array.from(selectedUsers);
                    let done = 0;
                    users.forEach(u => {
                        google.script.run
                            .withSuccessHandler(() => { if (++done === users.length) { showToast('Users deleted'); loadUsers(); } })
                            .withFailureHandler(() => { if (++done === users.length) { showToast('Users deleted'); loadUsers(); } })
                            .adminDeleteUser({token: sessionToken, username: u});
                    });
                });
            };
        });
        // --- Search/filter ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').oninput = function(e) {
                const val = e.target.value.toLowerCase();
                filteredUsers = allUsers.filter(u =>
                    u.username.toLowerCase().includes(val) ||
                    (u.role||'').toLowerCase().includes(val) ||
                    (u.carrier||'').toLowerCase().includes(val)
                );
                currentPage = 1;
                renderTable();
            };
        });
        // --- Row selection ---
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('rowSelect')) {
                const username = e.target.getAttribute('data-username');
                if (e.target.checked) selectedUsers.add(username);
                else selectedUsers.delete(username);
                updateBulkDeleteBtn();
            }
            if (e.target.id === 'selectAll') {
                const check = e.target.checked;
                document.querySelectorAll('.rowSelect').forEach(cb => {
                    cb.checked = check;
                    const username = cb.getAttribute('data-username');
                    if (check) selectedUsers.add(username);
                    else selectedUsers.delete(username);
                });
                updateBulkDeleteBtn();
            }
        });
        // --- Keyboard shortcuts ---
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') { document.getElementById('searchInput').focus(); e.preventDefault(); }
            if (e.key === 'Escape') { document.getElementById('searchInput').value = ''; filteredUsers = allUsers; renderTable(); }
        });
        // --- Init ---
        initTheme();
        loadUsers();
    </script>
</body>
</html>
