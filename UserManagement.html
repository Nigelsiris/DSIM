<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        main { padding: 20px; }
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--card-background-color);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .stat-card h4 {
            margin: 0;
            color: var(--primary);
        }
        .stat-card p {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0 0 0;
        }
        .action-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .action-bar input[type="search"] {
            flex: 1;
            min-width: 200px;
            margin: 0;
        }
        .action-bar select {
            width: auto;
            margin: 0;
        }
        .bulk-actions {
            background: var(--card-background-color);
            border: 1px solid var(--muted-border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        .bulk-actions.active {
            display: block;
        }
        .table-wrapper {
            position: relative;
            overflow-x: auto;
        }
        .user-table th {
            cursor: pointer;
            user-select: none;
        }
        .user-table th:hover {
            background: var(--table-row-stripped-background-color);
        }
        .user-table th.sorted::after {
            content: ' ‚ñº';
            font-size: 0.8em;
        }
        .user-table th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.8em;
        }
        .user-row.selected {
            background: var(--primary-focus);
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-admin { background: #ff6b6b; color: white; }
        .badge-driver { background: #51cf66; color: white; }
        .badge-loadsupport { background: #339af0; color: white; }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .action-buttons button {
            margin: 0;
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        #feedback {
            position: sticky;
            bottom: 1rem;
            z-index: 100;
            background: var(--card-background-color);
            border: 2px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        #feedback.hidden {
            display: none;
        }
        #feedback.error {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        #feedback.success {
            border-color: #51cf66;
            color: #51cf66;
        }
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--contrast);
            color: var(--contrast-inverse);
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            margin-bottom: 4px;
        }
        [data-tooltip]:hover::after,
        [data-tooltip]:focus::after {
            opacity: 1;
        }
        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted-color);
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .empty-state h4 {
            margin: 0 0 0.5rem 0;
            color: var(--color);
        }
        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
            <button class="contrast" onclick="logout()">Logout</button>
            <button onclick="goBack()">Back to Dashboard</button>
        </div>
        
        <h1 style="text-align:center;">üë• User Management</h1>
        
        <!-- User Statistics -->
        <div class="user-stats" id="userStats">
            <div class="stat-card">
                <h4>Total Users</h4>
                <p id="statTotal">0</p>
            </div>
            <div class="stat-card">
                <h4>Admins</h4>
                <p id="statAdmins">0</p>
            </div>
            <div class="stat-card">
                <h4>Drivers</h4>
                <p id="statDrivers">0</p>
            </div>
            <div class="stat-card">
                <h4>Load Support</h4>
                <p id="statLoadSupport">0</p>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <input type="search" id="searchInput" placeholder="üîç Search users...">
            <select id="roleFilter" onchange="filterUsers()">
                <option value="">All Roles</option>
                <option value="Admin">Admin</option>
                <option value="Driver">Driver</option>
                <option value="Load Support">Load Support</option>
            </select>
            <select id="carrierFilter" onchange="filterUsers()">
                <option value="">All Carriers</option>
            </select>
            <button onclick="toggleSelectAll()" data-tooltip="Select/deselect all visible users">Select All</button>
            <button onclick="exportUsers()" class="secondary" data-tooltip="Download filtered users as CSV">üì• Export CSV</button>
            <button onclick="refreshUsers()" class="secondary outline" data-tooltip="Reload user list from server">üîÑ Refresh</button>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
            <h4>Bulk Actions (<span id="selectedCount">0</span> selected)</h4>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <select id="bulkRoleChange">
                    <option value="">Change Role To...</option>
                    <option value="Admin">Admin</option>
                    <option value="Driver">Driver</option>
                    <option value="Load Support">Load Support</option>
                </select>
                <button onclick="applyBulkRoleChange()" class="secondary" data-tooltip="Change role for all selected users">Apply Role Change</button>
                <button onclick="bulkDeleteUsers()" class="contrast" data-tooltip="Permanently delete all selected users">üóëÔ∏è Delete Selected</button>
                <button onclick="clearSelection()" class="secondary outline" data-tooltip="Deselect all users">Clear Selection</button>
            </div>
        </div>

        <!-- User Table -->
        <div class="table-wrapper">
            <table class="user-table" id="userTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                        <th onclick="sortTable('username')">Username</th>
                        <th onclick="sortTable('role')">Role</th>
                        <th onclick="sortTable('carrier')">Carrier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Users will be populated here -->
                </tbody>
            </table>
        </div>

        <p id="feedback" class="hidden">Loading users...</p>
    </main>

    <script>
        sessionToken = "<?= token ?>";
        let allUsers = [];
        let filteredUsers = [];
        let selectedUsers = new Set();
        let sortColumn = 'username';
        let sortAscending = true;

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            showFeedback('Loading users...', 'info');
            loadUsers();
            
            // Debounced search input
            var searchTimeout;
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(filterUsers, 300);
                });
            }
        });

        function showFeedback(message, type = 'info') {
            const feedback = document.getElementById('feedback');
            if (!feedback) return;
            
            feedback.innerText = message;
            feedback.className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            feedback.classList.remove('hidden');
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 5000);
            }
        }

        function logout() {
            google.script.run.withSuccessHandler(() => {
                const main = document.querySelector('main');
                if (main) main.innerHTML = '<h1>You have been logged out.</h1>';
            }).logoutUser({token: sessionToken});
        }

        function goBack() {
            google.script.run.withSuccessHandler(function(html) {
                document.open(); 
                document.write(html); 
                document.close();
            }).getAdminPageHtml(sessionToken);
        }

        function loadUsers() {
            google.script.run
                .withSuccessHandler(populateUsers)
                .withFailureHandler(function(err) {
                    showFeedback('Error loading users: ' + (err.message || err), 'error');
                })
                .getAllUsers({token: sessionToken});
        }

        function refreshUsers() {
            showFeedback('Refreshing users...', 'info');
            loadUsers();
        }

        function populateUsers(users) {
            if (!users || !Array.isArray(users)) {
                showFeedback('Error: Invalid user data received', 'error');
                return;
            }

            allUsers = users;
            updateStats();
            updateCarrierFilter();
            filterUsers();
            showFeedback(`Loaded ${users.length} users successfully`, 'success');
        }

        function updateStats() {
            const stats = {
                total: allUsers.length,
                admins: allUsers.filter(u => u.role === 'Admin').length,
                drivers: allUsers.filter(u => u.role === 'Driver').length,
                loadSupport: allUsers.filter(u => u.role === 'Load Support').length
            };

            const statTotal = document.getElementById('statTotal');
            const statAdmins = document.getElementById('statAdmins');
            const statDrivers = document.getElementById('statDrivers');
            const statLoadSupport = document.getElementById('statLoadSupport');

            if (statTotal) statTotal.innerText = stats.total;
            if (statAdmins) statAdmins.innerText = stats.admins;
            if (statDrivers) statDrivers.innerText = stats.drivers;
            if (statLoadSupport) statLoadSupport.innerText = stats.loadSupport;
        }

        function updateCarrierFilter() {
            const carriers = [...new Set(allUsers.map(u => u.carrier).filter(c => c))];
            const carrierFilter = document.getElementById('carrierFilter');
            if (!carrierFilter) return;

            const currentValue = carrierFilter.value;
            carrierFilter.innerHTML = '<option value="">All Carriers</option>';
            carriers.sort().forEach(carrier => {
                carrierFilter.innerHTML += `<option value="${carrier}">${carrier}</option>`;
            });
            carrierFilter.value = currentValue;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('roleFilter')?.value || '';
            const carrierFilter = document.getElementById('carrierFilter')?.value || '';

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.username.toLowerCase().includes(searchTerm) ||
                    (user.carrier || '').toLowerCase().includes(searchTerm);
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesCarrier = !carrierFilter || user.carrier === carrierFilter;
                return matchesSearch && matchesRole && matchesCarrier;
            });

            sortUsers();
            renderUsers();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }
            sortUsers();
            renderUsers();
        }

        function sortUsers() {
            filteredUsers.sort((a, b) => {
                let aVal = a[sortColumn] || '';
                let bVal = b[sortColumn] || '';
                
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });
        }

        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (filteredUsers.length === 0) {
                var emptyMessage = allUsers.length === 0 
                    ? '<div class="empty-state"><div class="empty-state-icon">üë•</div><h4>No Users Found</h4><p>No users have been created yet. Users are added when they register through the login page.</p></div>'
                    : '<div class="empty-state"><div class="empty-state-icon">üîç</div><h4>No Matching Users</h4><p>Try adjusting your search or filters to find what you\'re looking for.</p></div>';
                tbody.innerHTML = '<tr><td colspan="5">' + emptyMessage + '</td></tr>';
                return;
            }

            filteredUsers.forEach(user => {
                const isSelected = selectedUsers.has(user.username);
                const roleBadge = getRoleBadge(user.role);
                
                const row = document.createElement('tr');
                row.className = isSelected ? 'user-row selected' : 'user-row';
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleUserSelection('${escapeHtml(user.username)}')">
                    </td>
                    <td><strong>${escapeHtml(user.username)}</strong></td>
                    <td>${roleBadge}</td>
                    <td>${escapeHtml(user.carrier || 'N/A')}</td>
                    <td class="action-buttons">
                        <button class="secondary" onclick="editUser('${escapeHtml(user.username)}', '${escapeHtml(user.role)}', '${escapeHtml(user.carrier || '')}')" data-tooltip="Edit role and carrier">‚úèÔ∏è Edit</button>
                        <button class="secondary outline" onclick="resetPassword('${escapeHtml(user.username)}')" data-tooltip="Set a new password">üîë Reset</button>
                        <button class="contrast outline" onclick="deleteUser('${escapeHtml(user.username)}')" data-tooltip="Permanently remove user">üóëÔ∏è Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateSortIndicators();
        }

        function getRoleBadge(role) {
            const badgeClass = role.toLowerCase().replace(/\s+/g, '');
            return `<span class="badge badge-${badgeClass}">${escapeHtml(role)}</span>`;
        }

        function updateSortIndicators() {
            document.querySelectorAll('.user-table th').forEach(th => {
                th.classList.remove('sorted', 'sorted-asc');
            });

            const headers = document.querySelectorAll('.user-table th');
            const columnIndex = ['username', 'role', 'carrier'].indexOf(sortColumn);
            if (columnIndex >= 0 && headers[columnIndex + 1]) {
                headers[columnIndex + 1].classList.add(sortAscending ? 'sorted-asc' : 'sorted');
            }
        }

        function toggleUserSelection(username) {
            if (selectedUsers.has(username)) {
                selectedUsers.delete(username);
            } else {
                selectedUsers.add(username);
            }
            updateBulkActions();
            renderUsers();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (selectAllCheckbox && selectAllCheckbox.checked) {
                filteredUsers.forEach(user => selectedUsers.add(user.username));
            } else {
                selectedUsers.clear();
            }
            
            updateBulkActions();
            renderUsers();
        }

        function clearSelection() {
            selectedUsers.clear();
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkActions();
            renderUsers();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedCount) selectedCount.innerText = selectedUsers.size;
            
            if (bulkActions) {
                if (selectedUsers.size > 0) {
                    bulkActions.classList.add('active');
                } else {
                    bulkActions.classList.remove('active');
                }
            }
        }

        function editUser(username, currentRole, currentCarrier) {
            const newUsername = prompt(`Enter new username for "${username}":\n(Leave unchanged or enter new username)`, username);
            if (newUsername === null) return;
            if (!newUsername.trim()) {
                showFeedback('Username cannot be empty', 'error');
                return;
            }
            const newRole = prompt(`Enter new role for "${newUsername}":\n(Admin, Driver, or Load Support)`, currentRole);
            if (newRole === null) return;
            if (!['Admin', 'Driver', 'Load Support'].includes(newRole)) {
                showFeedback('Invalid role. Must be Admin, Driver, or Load Support', 'error');
                return;
            }
            const newCarrier = prompt(`Enter new carrier for "${newUsername}":\n(Optional - press OK to keep current)`, currentCarrier);
            if (newCarrier !== null) {
                showFeedback('Updating user...', 'info');
                google.script.run
                    .withSuccessHandler((result) => {
                        if (result && result.startsWith('Error:')) {
                            showFeedback(result, 'error');
                        } else {
                            showFeedback(result || `User updated successfully`, 'success');
                            loadUsers();
                        }
                    })
                    .withFailureHandler(err => showFeedback('Error: ' + (err.message || err), 'error'))
                    .adminEditUser({token: sessionToken, username: username, newUsername: newUsername.trim(), role: newRole, carrier: newCarrier});
            }
        }

        function resetPassword(username) {
            const newPassword = prompt(`Enter a new password for user "${username}":`);
            if (newPassword) {
                showFeedback('Resetting password...', 'info');
                google.script.run
                    .withSuccessHandler(() => {
                        showFeedback(`Password reset for "${username}"`, 'success');
                        loadUsers();
                    })
                    .withFailureHandler(err => showFeedback('Error: ' + (err.message || err), 'error'))
                    .adminResetPassword({token: sessionToken, username: username, newPassword: newPassword});
            }
        }

        function deleteUser(username) {
            if (confirm(`Are you sure you want to permanently delete user "${username}"?`)) {
                showFeedback('Deleting user...', 'info');
                google.script.run
                    .withSuccessHandler(() => {
                        showFeedback(`User "${username}" deleted`, 'success');
                        selectedUsers.delete(username);
                        loadUsers();
                    })
                    .withFailureHandler(err => showFeedback('Error: ' + (err.message || err), 'error'))
                    .adminDeleteUser({token: sessionToken, username: username});
            }
        }

        function applyBulkRoleChange() {
            const newRole = document.getElementById('bulkRoleChange')?.value;
            if (!newRole) {
                alert('Please select a role');
                return;
            }

            if (selectedUsers.size === 0) {
                alert('No users selected');
                return;
            }

            if (confirm(`Change role to "${newRole}" for ${selectedUsers.size} user(s)?`)) {
                showFeedback(`Updating ${selectedUsers.size} users...`, 'info');
                google.script.run
                    .withSuccessHandler(() => {
                        showFeedback(`Successfully updated ${selectedUsers.size} users`, 'success');
                        clearSelection();
                        loadUsers();
                    })
                    .withFailureHandler(err => showFeedback('Error: ' + (err.message || err), 'error'))
                    .adminBulkEditUsers({token: sessionToken, usernames: Array.from(selectedUsers), role: newRole});
            }
        }

        function bulkDeleteUsers() {
            if (selectedUsers.size === 0) {
                alert('No users selected');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedUsers.size} user(s)? This cannot be undone!`)) {
                showFeedback(`Deleting ${selectedUsers.size} users...`, 'info');
                google.script.run
                    .withSuccessHandler(() => {
                        showFeedback(`Successfully deleted ${selectedUsers.size} users`, 'success');
                        clearSelection();
                        loadUsers();
                    })
                    .withFailureHandler(err => showFeedback('Error: ' + (err.message || err), 'error'))
                    .adminBulkDeleteUsers({token: sessionToken, usernames: Array.from(selectedUsers)});
            }
        }

        function exportUsers() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `users_export_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showFeedback('Users exported successfully', 'success');
        }

        function generateCSV() {
            let csv = 'Username,Role,Carrier\n';
            filteredUsers.forEach(user => {
                csv += `"${user.username}","${user.role}","${user.carrier || ''}"\n`;
            });
            return csv;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
