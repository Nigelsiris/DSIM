<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- Removed external styles.css link for Apps Script compatibility -->
    <style>
        main { max-width: 500px; margin: 2rem auto; }
        #quickLogin { margin-top: 1.5rem; text-align: center; }
        #quickLogin h5 { margin-bottom: 0.5rem; }
        #quickLogin .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    </style>
</head>
<body>
    <div id="topRightControls" style="position: absolute; top: 1rem; right: 1rem; z-index: 10; display: flex; gap: 8px; align-items: center;"></div>
    <main class="container">

        <article>
            <div style="text-align: center;">
                <h2>System Login</h2>
            </div>
            <label for="username">Username</label>
            <input type="text" id="username" name="username" autocomplete="off">
            <label for="password">Password</label>
            <input type="password" id="password" name="password">
            <button id="loginButton" style="width:100%;">Login</button>
            <div class="progress-bar" id="loginProgress">
                <div class="fill"></div>
            </div>
            <div class="login-feedback">
                <div class="spinner" style="display: none;"></div>
                <p id="feedback" style="margin: 0;"></p>
            </div>
        </article>

        <? if (activeDrivers && activeDrivers.length > 0) { ?>
        <section id="quickLogin">
            <h5>Quick Login for Check-In:</h5>
            <div class="grid">
                <? for (var i = 0; i < activeDrivers.length; i++) { ?>
                    <button class="secondary outline quick-login-button" onclick="prefillLogin('<?= activeDrivers[i].username ?>')" id="quick-login-<?= i ?>">
                        <?= activeDrivers[i].displayName ?>
                    </button>
                <? } ?>
            </div>
        </section>
        <? } ?>


    </main>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#222; color:#fff; padding:12px 24px; border-radius:24px; z-index:3000; font-size:1rem; min-width:120px; text-align:center;"></div>

    <script>
        // --- Progress bar and spinner helpers ---
        function updateProgress(step) {
            const progressBar = document.getElementById("loginProgress");
            const fill = progressBar.querySelector(".fill");
            progressBar.style.display = "block";
            fill.style.width = `${step * 33.33}%`;
        }

        function showSpinner(show) {
            const spinner = document.querySelector(".spinner");
            spinner.style.display = show ? "inline-block" : "none";
        }
        // Ensure login button works and Enter key submits
        document.getElementById("loginButton").addEventListener("click", attemptLogin);
        document.getElementById("password").addEventListener("keydown", function(e) {
            if (e.key === "Enter") attemptLogin();
        });

        function prefillLogin(username) {
            const buttonId = Array.from(document.querySelectorAll('.quick-login-button')).find(
                btn => btn.textContent.trim() === username
            )?.id;
            if (buttonId) {
                document.getElementById(buttonId).setAttribute("aria-busy", "true");
            }
            document.getElementById('username').value = username;
            document.getElementById('password').focus();
            setTimeout(() => {
                if (buttonId) document.getElementById(buttonId).removeAttribute("aria-busy");
            }, 500);
        }
        // --- Theme management ---
        const THEME_KEY = 'dsim_theme';
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            addThemeToggle();
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
        }
        function addThemeToggle() {
            if (document.getElementById('themeToggleBtn')) return;
            const toggle = document.createElement('button');
            toggle.className = 'theme-toggle';
            toggle.id = 'themeToggleBtn';
            toggle.innerHTML = `<span>ðŸŒ“</span><span>Theme</span>`;
            toggle.onclick = toggleTheme;
            const controls = document.getElementById('topRightControls');
            if (controls) {
                controls.appendChild(toggle);
            } else {
                document.body.appendChild(toggle);
            }
        }
        // --- Loading overlay ---
        function showLoading() { document.querySelector('.loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.querySelector('.loading-overlay').style.display = 'none'; }
        // --- Toasts ---
        function showToast(msg, isError) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.background = isError ? '#c0392b' : '#222';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2500);
        }
    // --- Init theme ---
    initTheme();

        async function attemptLogin() {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");
            
            loginButton.setAttribute("aria-busy", "true");
            showSpinner(true);
            showLoading();
            document.getElementById("loginProgress").style.display = "block";
            updateProgress(1);
            feedback.innerText = "Initializing login...";

            const user = document.getElementById("username").value;
            const pass = document.getElementById("password").value;

            // Start location request and authentication in parallel
            const locationPromise = new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    }),
                    () => resolve(null),
                    { timeout: 5000 } // 5 second timeout
                );
            });

            updateProgress(2);
            feedback.innerText = "Processing...";

            // Wait for location (with timeout) and proceed with login
            const coords = await locationPromise;
            
            updateProgress(3);
            feedback.innerText = "Authenticating...";

            const loginData = {
                username: user,
                password: pass,
                latitude: coords ? coords.latitude : null,
                longitude: coords ? coords.longitude : null
            };

            google.script.run
                .withSuccessHandler(function(data) { onLoginSuccess(data); hideLoading(); })
                .withFailureHandler(function(err) { onLoginFailure(err); hideLoading(); showToast('Login failed', true); })
                .loginAndGetUserView(loginData);
        }

        function onLoginFailure(error) {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");
            const progressBar = document.getElementById("loginProgress");
            
            loginButton.removeAttribute("aria-busy");
            showSpinner(false);
            progressBar.style.display = "none";
            feedback.innerText = "Login failed. Please try again.";
            showToast('Login failed. Please try again.', true);
        }

        function onLoginSuccess(sessionData) {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");
            const progressBar = document.getElementById("loginProgress");
            
            loginButton.removeAttribute("aria-busy");
            showSpinner(false);
            progressBar.style.display = "none";
            if (sessionData && sessionData.token) {
                if (sessionData.role === 'Admin' || sessionData.role === 'Load Support') {
                    localStorage.setItem('sessionToken', sessionData.token);
                }
                feedback.innerText = "Login successful!";
                showToast('Login successful!');
                handleLoginSuccess(sessionData);
            } else {
                feedback.innerText = "Invalid username or password.";
                showToast('Invalid username or password.', true);
            }
        }
        

    </script>
</body>
</html>