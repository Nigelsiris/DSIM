<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <?!= include('SharedStyles'); ?>
    <?!= include('AppShellStyles'); ?>
    <style>
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #1095c1;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        main { max-width: 500px; margin: 2rem auto; }
        #quickLogin { margin-top: 1.5rem; text-align: center; }
        #quickLogin h5 { margin-bottom: 0.5rem; }
        #quickLogin .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    </style>
</head>
<body>
    <div id="topRightControls" class="top-controls"></div>
    <main class="container">

        <article>
            <div style="text-align: center;">
                <h2>System Login</h2>
            </div>
            <label for="username">Username</label>
            <input type="text" id="username" name="username" autocomplete="off">
            <label for="password">Password</label>
            <input type="password" id="password" name="password">
            <button id="loginButton" style="width:100%;">Login</button>
            <div class="progress-bar" id="loginProgress">
                <div class="fill"></div>
            </div>
            <div class="login-feedback">
                <div class="spinner" style="display: none;"></div>
                <p id="feedback" style="margin: 0;"></p>
            </div>
        </article>

        <? if (activeDrivers && activeDrivers.length > 0) { ?>
        <section id="quickLogin">
            <h5>Quick Login for Check-In:</h5>
            <div class="grid">
                <? for (var i = 0; i < activeDrivers.length; i++) { ?>
                    <button class="secondary outline quick-login-button" onclick="prefillLogin('<?= activeDrivers[i].username ?>')" id="quick-login-<?= i ?>">
                        <?= activeDrivers[i].displayName ?>
                    </button>
                <? } ?>
            </div>
        </section>
        <? } ?>


    </main>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="assertive"></div>

    <?!= include('AppShellScript'); ?>
    <script>
        const app = AppShell.init();
        // --- Progress bar and spinner helpers ---
        function updateProgress(step) {
            const progressBar = document.getElementById("loginProgress");
            const fill = progressBar.querySelector(".fill");
            progressBar.style.display = "block";
            fill.style.width = `${step * 33.33}%`;
        }

        function showSpinner(show) {
            const spinner = document.querySelector(".spinner");
            spinner.style.display = show ? "inline-block" : "none";
        }
        // Ensure login button works and Enter key submits
        document.getElementById("loginButton").addEventListener("click", attemptLogin);
        document.getElementById("password").addEventListener("keydown", function(e) {
            if (e.key === "Enter") attemptLogin();
        });

        function prefillLogin(username) {
            const buttonId = Array.from(document.querySelectorAll('.quick-login-button')).find(
                btn => btn.textContent.trim() === username
            )?.id;
            if (buttonId) {
                document.getElementById(buttonId).setAttribute("aria-busy", "true");
            }
            document.getElementById('username').value = username;
            document.getElementById('password').focus();
            setTimeout(() => {
                if (buttonId) document.getElementById(buttonId).removeAttribute("aria-busy");
            }, 500);
        }
        async function attemptLogin() {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");

            loginButton.setAttribute("aria-busy", "true");
            showSpinner(true);
            app.showLoading();
            document.getElementById("loginProgress").style.display = "block";
            updateProgress(1);
            feedback.innerText = "Initializing login...";

            const user = document.getElementById("username").value;
            const pass = document.getElementById("password").value;

            // Start location request and authentication in parallel
            const locationPromise = new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    }),
                    () => resolve(null),
                    { timeout: 5000 } // 5 second timeout
                );
            });

            updateProgress(2);
            feedback.innerText = "Processing...";

            // Wait for location (with timeout) and proceed with login
            const coords = await locationPromise;
            
            updateProgress(3);
            feedback.innerText = "Authenticating...";

            const loginData = {
                username: user,
                password: pass,
                latitude: coords ? coords.latitude : null,
                longitude: coords ? coords.longitude : null
            };

            google.script.run
                .withSuccessHandler(function(data) { onLoginSuccess(data); app.hideLoading(); })
                .withFailureHandler(function(err) { onLoginFailure(err); app.hideLoading(); app.toast('Login failed', { variant: 'error' }); })
                .loginAndGetUserView(loginData);
        }

        function onLoginFailure(error) {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");
            const progressBar = document.getElementById("loginProgress");
            
            loginButton.removeAttribute("aria-busy");
            showSpinner(false);
            progressBar.style.display = "none";
            feedback.innerText = "Login failed. Please try again.";
            app.toast('Login failed. Please try again.', { variant: 'error' });
        }

        function onLoginSuccess(sessionData) {
            const loginButton = document.getElementById("loginButton");
            const feedback = document.getElementById("feedback");
            const progressBar = document.getElementById("loginProgress");
            
            loginButton.removeAttribute("aria-busy");
            showSpinner(false);
            progressBar.style.display = "none";
            if (sessionData && sessionData.token) {
                if (sessionData.role === 'Admin' || sessionData.role === 'Load Support') {
                    localStorage.setItem('sessionToken', sessionData.token);
                }
                feedback.innerText = "Login successful!";
                app.toast('Login successful!');
                handleLoginSuccess(sessionData);
            } else {
                feedback.innerText = "Invalid username or password.";
                app.toast('Invalid username or password.', { variant: 'error' });
            }
        }
        

    </script>
</body>
</html>