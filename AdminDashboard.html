<!DOCTYPE html>
<html>
    <head>
        <base target="_top">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
        <style> 
            main { padding: 20px; }
            
            /* EPJ Grid Enhancements */
            .epj-card {
                border: 2px solid;
                padding: 10px;
                text-align: center;
                border-radius: 5px;
                cursor: pointer;
                position: relative;
                transition: transform 0.2s, box-shadow 0.2s;
                user-select: none;
            }
            
            .epj-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            
            .epj-card.store-only::after {
                content: '[S]';
                position: absolute;
                top: 2px;
                right: 2px;
                font-size: 0.8em;
                font-weight: bold;
                color: var(--primary);
            }
            
            /* Context Menu */
            .context-menu {
                position: fixed;
                background: var(--card-background-color);
                border: 1px solid var(--muted-border-color);
                border-radius: 0.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                padding: 0.5rem 0;
                z-index: 1000;
                min-width: 200px;
                display: none;
            }
            
            .context-menu.active {
                display: block;
            }
            
            .context-menu-item {
                padding: 0.5rem 1rem;
                cursor: pointer;
                transition: background 0.2s;
                border: none;
                background: none;
                width: 100%;
                text-align: left;
                color: inherit;
                font-size: 0.9rem;
            }
            
            .context-menu-item:hover {
                background: var(--primary-focus);
            }
            
            .context-menu-divider {
                height: 1px;
                background: var(--muted-border-color);
                margin: 0.25rem 0;
            }
            
            .toggle-indicator {
                float: right;
                font-size: 0.9em;
            }
            
            /* Driver Login Notification */
            .notification-toast {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 1rem 2rem;
                border-radius: 0.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 2000;
                display: none;
                animation: slideDown 0.3s ease-out;
                font-weight: bold;
            }
            
            .notification-toast.show {
                display: block;
            }
            
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            
            .notification-badge {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--primary);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                font-size: 0.85rem;
                z-index: 1500;
                display: none;
            }
            
            .notification-badge.show {
                display: block;
            }
            
            /* Loading spinner for buttons */
            .btn-loading {
                position: relative;
                pointer-events: none;
                opacity: 0.7;
            }
            
            .btn-loading::after {
                content: '';
                position: absolute;
                width: 1em;
                height: 1em;
                top: 50%;
                left: 50%;
                margin-top: -0.5em;
                margin-left: -0.5em;
                border: 2px solid transparent;
                border-top-color: currentColor;
                border-radius: 50%;
                animation: btn-spin 0.6s linear infinite;
            }
            
            .btn-loading span {
                visibility: hidden;
            }
            
            @keyframes btn-spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <main class="container">
            <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                <button class="contrast" onclick="logout()">Logout</button>
            </div>

            <h1 style="text-align:center;">Admin Control Panel</h1>
            
            <article>
                <h3 style="text-align:center;">EPJ Management <small>(Right-click for quick actions)</small></h3>
                <div id="statusGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;"></div>
            </article>

            <article>
                <h3><ins>Live Check-Outs</ins></h3>
                <div class="overflow-auto">
                    <table id="activeCheckoutsTable">
                        <thead><tr><th>Driver</th><th>Carrier</th><th>EPJ</th><th>Truck/Trailer</th><th>Route</th><th>Check-Out Time</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </article>

            <div class="grid">
                <article>
                    <h3><ins>Add New User</ins></h3>
                    <input type="text" id="newUsername" placeholder="New Username" autocomplete="off">
                    <input type="password" id="newPassword" placeholder="New Password" autocomplete="off">
                    <input type="text" id="newCarrier" placeholder="Carrier Name (Optional)">
                    <select id="newRole"><option>Driver</option><option>Admin</option><option>Load Support</option></select>
                    <button id="addUserBtn" onclick="addUser()"><span>Create User</span></button>
                </article>
                <article>
                    <h3><ins>Maintenance Mode</ins></h3>
                    <select id="maintenanceEpj"></select>
                    <input type="text" id="maintenanceReason" placeholder="Reason for maintenance (optional)">
                    <select id="maintenanceAction">
                        <option value="Maintenance Start">Put IN Maintenance</option>
                        <option value="Maintenance End">Return FROM Maintenance</option>
                    </select>
                    <button id="maintenanceBtn" onclick="setMaintenance()"><span>Update Status</span></button>
                </article>
            </div>
            
            <article>
                <h3><ins>Mass Create Users</ins></h3>
                <blockquote>
                    Paste user data below in CSV format, one user per line:<br>
                    <small><b>Format:</b> <code>username,password,Role,CarrierName</code></small><br>
                    <small><b>Example:</b> <code>jdoe,Password123,Driver,Carrier A</code></small>
                </blockquote>
                <textarea id="massUserCsv" placeholder="user1,pass1,Driver,Carrier A&#10;user2,pass2,Admin,Carrier B" style="height: 150px;"></textarea>
                <button id="massCreateBtn" onclick="massCreateUsers()"><span>Create Multiple Users</span></button>
            </article>

            <article>
                <button id="userMgmtBtn" style="width:100%;margin-top:2em;" onclick="openUserManagement()"><span>Open User Management</span></button>
            </article>

            <article>
                <h3><ins>EPJ Fleet Management</ins></h3>
                <div class="grid">
                    <div>
                        <label>Add New EPJ</label>
                        <input type="text" id="newEpjNumber" placeholder="EPJ Number (e.g., EPJ-001)" autocomplete="off">
                        <label style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                            <input type="checkbox" id="newEpjStoreOnly" style="width:auto;">
                            <span>Store Delivery Only</span>
                        </label>
                        <button id="addEpjBtn" onclick="addNewEpj()"><span>Add EPJ</span></button>
                    </div>
                    <div>
                        <label>Remove EPJ</label>
                        <select id="removeEpjSelect">
                            <option value="" disabled selected>Select EPJ to remove...</option>
                        </select>
                        <p style="font-size:0.85rem; color:var(--pico-muted-color); margin-bottom:0.5rem;">Note: Cannot remove EPJs that are currently checked out.</p>
                        <button id="removeEpjBtn" class="secondary" onclick="removeEpj()"><span>Remove EPJ</span></button>
                    </div>
                </div>
            </article>

            <article>
                <h3><ins>Recent Maintenance Events</ins></h3>
                <div class="overflow-auto">
                    <table id="maintenanceTable">
                        <thead><tr><th>Timestamp</th><th>EPJ</th><th>Event</th><th>Reason</th><th>Resolution</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </article>

            <p id="feedback" style="text-align:center; min-height: 20px;"></p>
        </main>

        <!-- Driver Login Notification Toast -->
        <div id="loginNotification" class="notification-toast"></div>
        
        <!-- Recent Logins Badge -->
        <div id="recentLoginsBadge" class="notification-badge"></div>

        <!-- Context Menu for EPJ Cards -->
        <div id="epjContextMenu" class="context-menu">
            <div class="context-menu-item" onclick="quickChangeStatus('Available')">Set Available</div>
            <div class="context-menu-item" onclick="quickChangeStatus('Checked Out')">Set Checked Out</div>
            <div class="context-menu-item" onclick="quickChangeStatus('Maintenance')">Set Maintenance</div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="toggleStoreOnly()">
                Store Delivery Only <span class="toggle-indicator" id="storeToggleIndicator"></span>
            </div>
        </div>

        <script>
            (function() {
                // Get token from multiple sources to ensure we have it
                var _token = null;
                
                // First try the server-side template variable
                <?
                  if (typeof token !== 'undefined' && token) {
                    output.append('_token = "' + token + '";');
                  }
                ?>
                
                // If template didn't work, try global sessionToken
                if (!_token) {
                    if (typeof sessionToken !== 'undefined' && sessionToken) {
                        _token = sessionToken;
                    }
                }
                
                // Try localStorage as fallback
                if (!_token) {
                    _token = localStorage.getItem('sessionToken');
                }
                
                // Try parent window
                if (!_token) {
                    try {
                        if (window.parent && window.parent.sessionToken) {
                            _token = window.parent.sessionToken;
                        }
                    } catch(e) {}
                }
                
                // Set global sessionToken for other functions
                window.sessionToken = _token;
                
                // Debug: log token status
                console.log('Admin Dashboard token:', _token ? 'found' : 'NOT FOUND');

                var _isFirstLoad = true;
                var _currentContextEpj = null;
                var _allEpjDetails = [];
                var _lastSeenLoginTime = Date.now(); // Track last seen login to avoid duplicate notifications
                var _notificationSound = null;
                
                // Initialize notification sound (simple beep using Web Audio API)
                function initNotificationSound() {
                    try {
                        var AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (AudioContext) {
                            window._audioCtx = new AudioContext();
                        }
                    } catch(e) {
                        console.log('Audio not supported:', e);
                    }
                }
                initNotificationSound();
                
                function playChime() {
                    try {
                        if (!window._audioCtx) return;
                        var ctx = window._audioCtx;
                        if (ctx.state === 'suspended') ctx.resume();
                        
                        // Create a pleasant two-tone chime
                        var now = ctx.currentTime;
                        
                        // First tone (higher)
                        var osc1 = ctx.createOscillator();
                        var gain1 = ctx.createGain();
                        osc1.connect(gain1);
                        gain1.connect(ctx.destination);
                        osc1.frequency.value = 880; // A5
                        osc1.type = 'sine';
                        gain1.gain.setValueAtTime(0.3, now);
                        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        osc1.start(now);
                        osc1.stop(now + 0.3);
                        
                        // Second tone (lower, slight delay)
                        var osc2 = ctx.createOscillator();
                        var gain2 = ctx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc2.frequency.value = 659.25; // E5
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.3, now + 0.15);
                        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        osc2.start(now + 0.15);
                        osc2.stop(now + 0.5);
                    } catch(e) {
                        console.log('Error playing chime:', e);
                    }
                }
                
                function showNotification(username) {
                    var toast = document.getElementById('loginNotification');
                    if (toast) {
                        toast.innerHTML = 'Driver "' + username + '" has signed in!';
                        toast.classList.add('show');
                        playChime();
                        
                        // Auto-hide after 5 seconds
                        setTimeout(function() {
                            toast.classList.remove('show');
                        }, 5000);
                    }
                }
                
                function checkForNewDriverLogins() {
                    if (!_token) return;
                    
                    google.script.run
                        .withSuccessHandler(function(logins) {
                            if (logins && logins.length > 0) {
                                // Check for logins newer than our last seen time
                                logins.forEach(function(login) {
                                    if (login.timestampMs > _lastSeenLoginTime) {
                                        showNotification(login.username);
                                        _lastSeenLoginTime = login.timestampMs;
                                    }
                                });
                                
                                // Update badge with recent count
                                var badge = document.getElementById('recentLoginsBadge');
                                if (badge && logins.length > 0) {
                                    badge.innerHTML = logins.length + ' recent driver login' + (logins.length > 1 ? 's' : '');
                                    badge.classList.add('show');
                                } else if (badge) {
                                    badge.classList.remove('show');
                                }
                            } else {
                                var badge = document.getElementById('recentLoginsBadge');
                                if (badge) badge.classList.remove('show');
                            }
                        })
                        .withFailureHandler(function(err) {
                            console.log('Error checking driver logins:', err.message);
                        })
                        .getRecentDriverLogins({token: _token, minutesBack: 2});
                }
                
                // Check for new logins every 15 seconds
                if (window.loginCheckTimer) clearInterval(window.loginCheckTimer);
                window.loginCheckTimer = setInterval(checkForNewDriverLogins, 15000);
                // Initial check after 3 seconds (give page time to load)
                setTimeout(checkForNewDriverLogins, 3000);
                
                // Clear any previously existing timer before this script runs again.
                if (window.dashboardRefreshTimer) {
                    clearInterval(window.dashboardRefreshTimer);
                }

                // Close context menu when clicking anywhere
                document.addEventListener('click', function(e) {
                    var menu = document.getElementById('epjContextMenu');
                    if (menu && !e.target.closest('.context-menu') && !e.target.closest('.epj-card')) {
                        hideContextMenu();
                    }
                });
                
                // Prevent default context menu on the entire page to avoid conflicts
                document.addEventListener('contextmenu', function(e) {
                    if (e.target.closest('.epj-card')) {
                        e.preventDefault();
                    }
                });

                window.logout = function() {
                    if (window.dashboardRefreshTimer) clearInterval(window.dashboardRefreshTimer);
                    if (window.loginCheckTimer) clearInterval(window.loginCheckTimer);
                    google.script.run.withSuccessHandler(function() {
                        var mainEl = document.querySelector('main');
                        if (mainEl) mainEl.innerHTML = '<h1>You have been logged out.</h1>';
                    }).logoutUser({token: _token});
                };

                function loadDashboardData() {
                    var feedback = document.getElementById('feedback');
                    if (_isFirstLoad && feedback) { feedback.innerText = 'Loading data...'; }
                    
                    if (!_token) {
                        if (feedback) feedback.innerText = 'Error: No session token. Please log in again.';
                        return;
                    }
                    
                    google.script.run
                        .withSuccessHandler(populateDashboard)
                        .withFailureHandler(function(err) {
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = 'Error loading data: ' + (err.message || 'Unknown error');
                            if (err.message && err.message.indexOf("Permission denied") !== -1) { 
                                if (window.dashboardRefreshTimer) clearInterval(window.dashboardRefreshTimer);
                                setTimeout(function() { if (typeof logout === 'function') logout(); }, 2000); 
                            }
                        })
                        .getDashboardData({token: _token});
                    
                    // Load EPJ details for context menu
                    google.script.run
                        .withSuccessHandler(function(details) {
                            _allEpjDetails = details || [];
                        })
                        .withFailureHandler(function(err) {
                            console.log('Error loading EPJ details:', err.message);
                        })
                        .getAllEpjsWithDetails({token: _token});
                }
                
                // Load immediately when page loads
                loadDashboardData();
                // Assign the timer to a property on the global 'window' object to prevent re-declaration errors.
                window.dashboardRefreshTimer = setInterval(loadDashboardData, 60000);

                function populateDashboard(data) {
                    var feedback = document.getElementById('feedback');
                    if (!data) { 
                        if (feedback) feedback.innerText = 'Error: No data received from server. Token may be invalid.'; 
                        return; 
                    }
                    var grid = document.getElementById('statusGrid');
                    var maintenanceSelect = document.getElementById('maintenanceEpj');
                    if (grid) grid.innerHTML = '';
                    if (maintenanceSelect) maintenanceSelect.innerHTML = '<option disabled selected>Select EPJ...</option>';
                    
                    if (data.epjStatuses && data.epjStatuses.length > 0) {
                        data.epjStatuses.forEach(function(item) {
                            var color = item.status === 'Available' ? 'green' : (item.status === 'Checked Out' ? 'red' : 'orange');
                            var storeOnlyClass = item.storeOnly ? ' store-only' : '';
                            var cardDiv = document.createElement('div');
                            cardDiv.className = 'epj-card' + storeOnlyClass;
                            cardDiv.style.borderColor = color;
                            cardDiv.style.color = color;
                            cardDiv.innerHTML = '<b>' + item.epj + '</b><br><small>' + item.status + '</small>';
                            cardDiv.dataset.epj = item.epj;
                            cardDiv.dataset.status = item.status;
                            cardDiv.dataset.storeOnly = item.storeOnly || false;
                            
                            // Add right-click event
                            cardDiv.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                showContextMenu(e, item.epj, item.storeOnly);
                            });
                            
                            if (grid) grid.appendChild(cardDiv);
                            if (maintenanceSelect) maintenanceSelect.innerHTML += '<option>' + item.epj + '</option>';
                        });
                    } else {
                        if (grid) grid.innerHTML = '<p>No EPJs found in the system.</p>';
                    }
                    
                    var activeTableBody = document.querySelector('#activeCheckoutsTable tbody');
                    if (activeTableBody) {
                        activeTableBody.innerHTML = '';
                        if (data.activeCheckouts && data.activeCheckouts.length > 0) {
                            data.activeCheckouts.forEach(function(trip) {
                                activeTableBody.innerHTML += '<tr><td>' + trip.driver + '</td><td>' + trip.carrier + '</td><td>' + trip.epj + '</td><td>' + trip.truck + ' / ' + trip.trailer + '</td><td>' + trip.route + '</td><td>' + trip.timestamp + '</td><td><button class="secondary outline" onclick="forceCheckIn(\'' + trip.tripId + '\', \'' + trip.epj + '\')">Force Check-In</button></td></tr>';
                            });
                        } else {
                            activeTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No active checkouts</td></tr>';
                        }
                    }
                    
                    var maintTableBody = document.querySelector('#maintenanceTable tbody');
                    if (maintTableBody) {
                        maintTableBody.innerHTML = '';
                        if (data.maintenanceLog && data.maintenanceLog.length > 0) {
                            data.maintenanceLog.forEach(function(row) {
                                var timestamp = new Date(row[0]).toLocaleString();
                                maintTableBody.innerHTML += '<tr><td>' + timestamp + '</td><td>' + row[1] + '</td><td>' + row[2] + '</td><td>' + row[3] + '</td><td>' + row[4] + '</td></tr>';
                            });
                        } else {
                            maintTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No maintenance events</td></tr>';
                        }
                    }
                    if (feedback) feedback.innerText = '';
                    _isFirstLoad = false;
                }

                function showContextMenu(event, epj, storeOnly) {
                    var menu = document.getElementById('epjContextMenu');
                    var indicator = document.getElementById('storeToggleIndicator');
                    
                    _currentContextEpj = epj;
                    
                    // Update toggle indicator (ASCII only to avoid template issues)
                    if (indicator) indicator.innerText = storeOnly ? 'Y' : '';
                    
                    // Position menu - ensure it stays within viewport
                    if (menu) {
                        // First show menu to get its dimensions
                        menu.style.visibility = 'hidden';
                        menu.classList.add('active');
                        
                        var menuWidth = menu.offsetWidth;
                        var menuHeight = menu.offsetHeight;
                        var viewportWidth = window.innerWidth;
                        var viewportHeight = window.innerHeight;
                        var scrollY = window.scrollY || window.pageYOffset;
                        var scrollX = window.scrollX || window.pageXOffset;
                        
                        // Calculate position
                        var left = event.pageX;
                        var top = event.pageY;
                        
                        // Adjust if menu would go off right edge
                        if (left + menuWidth > scrollX + viewportWidth) {
                            left = scrollX + viewportWidth - menuWidth - 10;
                        }
                        
                        // Adjust if menu would go off bottom edge
                        if (top + menuHeight > scrollY + viewportHeight) {
                            top = scrollY + viewportHeight - menuHeight - 10;
                        }
                        
                        // Ensure minimum positions
                        if (left < scrollX) left = scrollX + 10;
                        if (top < scrollY) top = scrollY + 10;
                        
                        menu.style.left = left + 'px';
                        menu.style.top = top + 'px';
                        menu.style.visibility = 'visible';
                    }
                }

                function hideContextMenu() {
                    var menu = document.getElementById('epjContextMenu');
                    if (menu) menu.classList.remove('active');
                }
                window.hideContextMenu = hideContextMenu;

                window.quickChangeStatus = function(newStatus) {
                    if (!_currentContextEpj) return;
                    
                    hideContextMenu();
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = 'Updating EPJ ' + _currentContextEpj + '...';
                    
                    google.script.run
                        .withSuccessHandler(function(message) {
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = message;
                            setTimeout(loadDashboardData, 500);
                        })
                        .withFailureHandler(function(err) {
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = 'Error: ' + (err.message || 'Unknown error');
                        })
                        .adminQuickUpdateEpjStatus({
                            token: _token,
                            epj: _currentContextEpj,
                            status: newStatus
                        });
                };

                window.toggleStoreOnly = function() {
                    if (!_currentContextEpj) return;
                    
                    var cardElement = document.querySelector('[data-epj="' + _currentContextEpj + '"]');
                    var currentStoreOnly = cardElement && cardElement.dataset.storeOnly === 'true';
                    var newStoreOnly = !currentStoreOnly;
                    
                    hideContextMenu();
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = 'Updating EPJ ' + _currentContextEpj + '...';
                    
                    google.script.run
                        .withSuccessHandler(function(message) {
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = message;
                            setTimeout(loadDashboardData, 500);
                        })
                        .withFailureHandler(function(err) {
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = 'Error: ' + (err.message || 'Unknown error');
                        })
                        .adminToggleStoreOnly({
                            token: _token,
                            epj: _currentContextEpj,
                            storeOnly: newStoreOnly
                        });
                };

                window.openUserManagement = function() {
                    var btn = document.getElementById('userMgmtBtn');
                    setButtonLoading(btn, true);
                    google.script.run
                        .withSuccessHandler(function(html) {
                            document.open(); document.write(html); document.close();
                        })
                        .withFailureHandler(function(err) {
                            setButtonLoading(btn, false);
                            alert('Error: ' + (err.message || 'Unknown error'));
                        })
                        .getUserManagementPage(_token);
                };
                
                // Helper functions for button loading states
                function setButtonLoading(btn, loading) {
                    if (!btn) return;
                    if (loading) {
                        btn.classList.add('btn-loading');
                        btn.disabled = true;
                    } else {
                        btn.classList.remove('btn-loading');
                        btn.disabled = false;
                    }
                }
                
                function handleSuccessWithBtn(btnId) {
                    return function(message) {
                        var btn = document.getElementById(btnId);
                        setButtonLoading(btn, false);
                        var feedback = document.getElementById('feedback');
                        if (feedback) feedback.innerText = message;
                        var fieldsToClear = ['newUsername', 'newPassword', 'newCarrier', 'massUserCsv', 'maintenanceReason'];
                        fieldsToClear.forEach(function(id) {
                            var el = document.getElementById(id);
                            if (el) el.value = '';
                        });
                        setTimeout(loadDashboardData, 500);
                    };
                }
                
                function handleFailureWithBtn(btnId) {
                    return function(err) {
                        var btn = document.getElementById(btnId);
                        setButtonLoading(btn, false);
                        var feedback = document.getElementById('feedback');
                        if (feedback) feedback.innerText = 'Error: ' + (err.message || 'Unknown error');
                    };
                }
                
                function handleSuccess(message) {
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = message;
                    var fieldsToClear = ['newUsername', 'newPassword', 'newCarrier', 'massUserCsv'];
                    fieldsToClear.forEach(function(id) {
                        var el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    setTimeout(loadDashboardData, 500);
                }

                window.massCreateUsers = function() {
                    var csvDataEl = document.getElementById('massUserCsv');
                    var csvData = csvDataEl ? csvDataEl.value : '';
                    if (!csvData.trim()) {
                        alert('Please paste user data into the text box.');
                        return;
                    }
                    var userCount = csvData.split('\n').filter(function(line) { return line.trim() !== ''; }).length;
                    if (confirm('Are you sure you want to create ' + userCount + ' new user(s)?')) {
                        var btn = document.getElementById('massCreateBtn');
                        setButtonLoading(btn, true);
                        google.script.run
                            .withSuccessHandler(handleSuccessWithBtn('massCreateBtn'))
                            .withFailureHandler(handleFailureWithBtn('massCreateBtn'))
                            .adminMassCreateUsers({token: _token, csvData: csvData});
                    }
                };

                window.forceCheckIn = function(tripId, epj) {
                    if (confirm('Are you sure you want to force check-in EPJ ' + epj + '?')) {
                        google.script.run.withSuccessHandler(handleSuccess).adminForceCheckIn({token: _token, tripId: tripId, epj: epj});
                    }
                };

                window.addUser = function() {
                    var usernameEl = document.getElementById('newUsername');
                    var passwordEl = document.getElementById('newPassword');
                    var roleEl = document.getElementById('newRole');
                    var carrierEl = document.getElementById('newCarrier');
                    var username = usernameEl ? usernameEl.value : '';
                    var password = passwordEl ? passwordEl.value : '';
                    var role = roleEl ? roleEl.value : 'Driver';
                    var carrier = carrierEl ? carrierEl.value : '';
                    if(!username || !password) { alert('Username and Password are required.'); return; }
                    var btn = document.getElementById('addUserBtn');
                    setButtonLoading(btn, true);
                    google.script.run
                        .withSuccessHandler(handleSuccessWithBtn('addUserBtn'))
                        .withFailureHandler(handleFailureWithBtn('addUserBtn'))
                        .adminAddUser({token: _token, username: username, password: password, role: role, carrier: carrier});
                };

                window.setMaintenance = function() {
                    var epjEl = document.getElementById('maintenanceEpj');
                    var actionEl = document.getElementById('maintenanceAction');
                    var reasonEl = document.getElementById('maintenanceReason');
                    var epj = epjEl ? epjEl.value : '';
                    var action = actionEl ? actionEl.value : '';
                    var reason = reasonEl ? reasonEl.value : '';
                    if(!epj) { alert("Please select an EPJ."); return; }
                    var btn = document.getElementById('maintenanceBtn');
                    setButtonLoading(btn, true);
                    google.script.run
                        .withSuccessHandler(handleSuccessWithBtn('maintenanceBtn'))
                        .withFailureHandler(handleFailureWithBtn('maintenanceBtn'))
                        .adminSetMaintenanceStatus({token: _token, epj: epj, status: action, reason: reason});
                };

                window.editUser = function(username, currentRole, currentCarrier) {
                    var newRole = prompt('Enter new role for "' + username + '": (Current: ' + currentRole + ')', currentRole);
                    if (newRole === null) return;
                    var newCarrier = prompt('Enter new carrier for "' + username + '": (Current: ' + currentCarrier + ')', currentCarrier);
                    if (newCarrier !== null) {
                        google.script.run.withSuccessHandler(handleSuccess).adminEditUser({token: _token, username: username, role: newRole, carrier: newCarrier});
                    }
                };
                
                window.resetPassword = function(username) {
                    var newPassword = prompt('Enter a new password for user "' + username + '":');
                    if (newPassword) {
                        google.script.run.withSuccessHandler(handleSuccess).adminResetPassword({token: _token, username: username, newPassword: newPassword});
                    }
                };
                
                window.deleteUser = function(username) {
                    if (confirm('Are you sure you want to permanently delete user "' + username + '"?')) {
                        google.script.run.withSuccessHandler(handleSuccess).adminDeleteUser({token: _token, username: username});
                    }
                };
                
                // EPJ Fleet Management Functions
                window.loadEpjManagementList = function() {
                    google.script.run
                        .withSuccessHandler(function(epjs) {
                            var select = document.getElementById('removeEpjSelect');
                            if (!select) return;
                            select.innerHTML = '<option value="" disabled selected>Select EPJ to remove...</option>';
                            if (epjs && epjs.length > 0) {
                                epjs.forEach(function(item) {
                                    var opt = document.createElement('option');
                                    opt.value = item.epj;
                                    var statusText = item.status === 'Checked Out' ? ' (CHECKED OUT)' : '';
                                    var storeText = item.storeOnly ? ' [Store Only]' : '';
                                    opt.textContent = item.epj + statusText + storeText;
                                    if (item.status === 'Checked Out') {
                                        opt.disabled = true;
                                    }
                                    select.appendChild(opt);
                                });
                            }
                        })
                        .withFailureHandler(function(err) {
                            console.error('Failed to load EPJ list:', err);
                        })
                        .adminGetAllEpjs({token: _token});
                };
                
                window.addNewEpj = function() {
                    var epjInput = document.getElementById('newEpjNumber');
                    var storeOnlyCheck = document.getElementById('newEpjStoreOnly');
                    var epjNumber = epjInput ? epjInput.value.trim() : '';
                    var storeOnly = storeOnlyCheck ? storeOnlyCheck.checked : false;
                    
                    if (!epjNumber) {
                        alert('Please enter an EPJ number.');
                        return;
                    }
                    
                    var btn = document.getElementById('addEpjBtn');
                    setButtonLoading(btn, true);
                    
                    google.script.run
                        .withSuccessHandler(function(message) {
                            setButtonLoading(btn, false);
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = message;
                            if (epjInput) epjInput.value = '';
                            if (storeOnlyCheck) storeOnlyCheck.checked = false;
                            loadDashboardData();
                            loadEpjManagementList();
                        })
                        .withFailureHandler(function(err) {
                            setButtonLoading(btn, false);
                            alert('Error: ' + (err.message || 'Failed to add EPJ'));
                        })
                        .adminAddEpj({token: _token, epjNumber: epjNumber, storeOnly: storeOnly});
                };
                
                window.removeEpj = function() {
                    var select = document.getElementById('removeEpjSelect');
                    var epjNumber = select ? select.value : '';
                    
                    if (!epjNumber) {
                        alert('Please select an EPJ to remove.');
                        return;
                    }
                    
                    if (!confirm('Are you sure you want to permanently remove EPJ "' + epjNumber + '" from the system?\\n\\nThis action cannot be undone.')) {
                        return;
                    }
                    
                    var btn = document.getElementById('removeEpjBtn');
                    setButtonLoading(btn, true);
                    
                    google.script.run
                        .withSuccessHandler(function(message) {
                            setButtonLoading(btn, false);
                            var feedback = document.getElementById('feedback');
                            if (feedback) feedback.innerText = message;
                            loadDashboardData();
                            loadEpjManagementList();
                        })
                        .withFailureHandler(function(err) {
                            setButtonLoading(btn, false);
                            alert('Error: ' + (err.message || 'Failed to remove EPJ'));
                        })
                        .adminRemoveEpj({token: _token, epjNumber: epjNumber});
                };
                
                // Load EPJ list on page load
                loadEpjManagementList();
            })();
        </script>
    </body>
</html>