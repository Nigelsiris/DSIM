<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <?!= include('SharedStyles'); ?>
    <?!= include('AppShellStyles'); ?>
    <style>
        main { padding: 20px; }
        td { vertical-align: middle; }
    </style>
</head>
<body>
    <div id="topRightControls" class="top-controls">
        <button class="contrast" onclick="logout()">Logout</button>
    </div>
    <main class="container">
        <h1 style="text-align:center;">EPJ Location Management</h1>
        <p>Welcome, <b><?!= username; ?></b>. Use this panel to update the location of any EPJ.</p>

        <article>
            <div class="overflow-auto">
                <table id="epjLocationTable">
                    <thead>
                        <tr>
                            <th>EPJ</th>
                            <th>Current Status</th>
                            <th>Current Location</th>
                            <th>Set New Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- EPJ data will be populated here by the script -->
                    </tbody>
                </table>
            </div>
        </article>
        <p id="feedback" style="text-align:center; min-height: 20px;"></p>
    </main>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="assertive"></div>

    <?!= include('AppShellScript'); ?>
    <script>
        const app = AppShell.init();
        const token = localStorage.getItem('sessionToken');
        const epjStatuses = <?!= epjStatuses; ?>;
        const epjInfoMap = <?!= epjInfoMap; ?>;
        const zoneOptionsHtml = `<?!= zoneOptions; ?>`;

        // Function to build the table when the page loads
        function buildTable() {
            const tableBody = document.querySelector('#epjLocationTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            epjStatuses.forEach(item => {
                const epjNumber = item.epj;
                const currentStatus = item.status;
                const currentLocation = epjInfoMap[epjNumber] ? epjInfoMap[epjNumber].location : 'Unknown';

                // Create the zone dropdown for each row
                const zoneSelectId = `zone-for-${epjNumber}`;
                const zoneDropdown = `<select id="${zoneSelectId}">${zoneOptionsHtml}</select>`;

                const rowHtml = `
                    <tr>
                        <td><strong>${epjNumber}</strong></td>
                        <td>${currentStatus}</td>
                        <td>${currentLocation}</td>
                        <td>${zoneDropdown}</td>
                        <td><button onclick="updateLocation('${epjNumber}')">Update</button></td>
                    </tr>
                `;
                tableBody.innerHTML += rowHtml;

                // Pre-select the current location in the dropdown
                if (currentLocation) {
                    const selectElement = document.getElementById(zoneSelectId);
                    if(selectElement) {
                       selectElement.value = currentLocation;
                    }
                }
            });
        }

        // Function to call the server to update a location
        function updateLocation(epj) {
            const selectId = `zone-for-${epj}`;
            const newLocation = document.getElementById(selectId).value;
            if (!newLocation) {
                app.toast('Please select a new location.', { variant: 'error' });
                return;
            }

            document.getElementById('feedback').innerText = `Updating location for ${epj}...`;
            app.showLoading();
            google.script.run
                .withSuccessHandler(message => {
                    document.getElementById('feedback').innerText = message;
                    app.toast(message);
                    app.hideLoading();
                    // Refresh the page to show the new location after a short delay
                    setTimeout(() => window.location.reload(), 2000);
                })
                .withFailureHandler(err => {
                    app.toast(err.message || 'Failed to update location', { variant: 'error' });
                    app.hideLoading();
                })
                .updateEpjLocation({ token: token, epj: epj, newLocation: newLocation });
        }

        // Build the table on page load
        buildTable();
    </script>
</body>
</html>