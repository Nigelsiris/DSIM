<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        main { max-width: 800px; margin: 2rem auto; }
        #epjInfoDisplay {
            padding: 0.75rem; border-radius: 0.25rem;
            background-color: var(--card-background-color); border: var(--card-border);
            margin-top: 1rem; min-height: 70px;
        }
        input[readonly] { background-color: var(--pico-muted-border-color); }
        
        /* Store delivery indicator */
        .store-only-badge {
            background: #1976d2;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.75rem; z-index: 10;">
                <button class="outline" onclick="loadProfilePage()">My Profile</button>
                <button class="contrast" onclick="logout()">Logout</button>
            </div>
            
            <h2>Driver Check-Out</h2>
            <p>Welcome, <b><?!= username; ?></b>. Please confirm your details to check out an EPJ.</p>

            <form id="checkOutForm">
                <div class="grid">
                    <label>Driver Name<input type="text" id="driverName" name="driverName" value="<?!= username; ?>" readonly></label>
                    <label>Truck Number<input type="text" id="truckNumber" name="truckNumber" required></label>
                </div>
                <div class="grid">
                    <label>Trailer Number<input type="text" id="trailerNumber" name="trailerNumber" required></label>
                    <label>Route<input type="text" id="route" name="route" required></label>
                </div>
                
                <hr>

                <label for="zoneFilter">Filter by Zone</label>
                <select id="zoneFilter" disabled>
                    <option value="All" selected>Loading zones...</option>
                </select>

                <label for="epjNumber">Select EPJ</label>
                <select id="epjNumber" name="epjNumber" required disabled>
                    <option value="" disabled selected>Loading...</option>
                </select>

                <div id="epjInfoDisplay"><small>Loading equipment data...</small></div>

                <label for="faultReport">Pre-Trip: Report any existing issues (optional)</label>
                <textarea id="faultReport" name="faultReport" placeholder="e.g., Fork is slightly bent, battery cover is cracked..."></textarea>
                
                <button type="submit" id="submitBtn">Complete Check-Out</button>
                <p id="feedback" style="text-align:center; min-height:20px;">Loading equipment data...</p>
            </form>
        </article>
    </main>
    <script>
        // Get token from parent window (Index.html) or localStorage
        if (!window.sessionToken) {
            window.sessionToken = (window.parent && window.parent.sessionToken) || localStorage.getItem('sessionToken') || "<?= token ?>";
        }
        let epjInfoMap = {};
        let availableEpjsData = []; // Stores objects with epj and storeOnly flag
        let zoneOptionsHtml = '';

        const zoneFilter = document.getElementById('zoneFilter');
        const epjSelect = document.getElementById('epjNumber');
        const infoDisplay = document.getElementById('epjInfoDisplay');
        const submitBtn = document.getElementById('submitBtn');
        
        // Disable form until data loads
        submitBtn.disabled = true;
        zoneFilter.disabled = true;

        // Load data asynchronously
        google.script.run
            .withSuccessHandler(function(data) {
                if (!data || !data.availableEpjs || typeof data.epjInfoMap !== 'object') {
                    document.getElementById('feedback').innerText = 'Error loading equipment data.';
                    infoDisplay.innerHTML = '<small style="color:red">Could not load equipment data. Please try again or contact admin.</small>';
                    epjSelect.innerHTML = '<option disabled selected>Error loading EPJs</option>';
                    submitBtn.disabled = true;
                    return;
                }
                
                // Process EPJ data with store-only flags
                availableEpjsData = data.availableEpjs.map(item => {
                    if (typeof item === 'string') {
                        return { epj: item, storeOnly: false };
                    }
                    return item;
                });
                
                epjInfoMap = data.epjInfoMap;
                zoneOptionsHtml = data.zoneOptions;

                // Populate zone filter - clear and rebuild
                zoneFilter.innerHTML = '<option value="All" selected>Show All Zones</option>';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = zoneOptionsHtml;
                Array.from(tempDiv.querySelectorAll('option')).forEach(opt => {
                    zoneFilter.appendChild(opt.cloneNode(true));
                });

                // Enable form
                zoneFilter.disabled = false;
                submitBtn.disabled = false;
                document.getElementById('feedback').innerText = '';
                infoDisplay.innerHTML = '<small>Select an EPJ to see its last reported status.</small>';

                // Initialize EPJ list
                updateEpjList();
            })
            .withFailureHandler(function(error) {
                document.getElementById('feedback').innerText = 'Error loading data: ' + error.message;
                infoDisplay.innerHTML = '<small style="color:red">Could not load equipment data. Please try again or contact admin.</small>';
                epjSelect.innerHTML = '<option disabled selected>Error loading EPJs</option>';
                submitBtn.disabled = true;
            })
            .getCheckoutFormData({token: window.sessionToken});

        function updateEpjList() {
            const selectedZone = zoneFilter.value;
            epjSelect.innerHTML = ''; 
            epjSelect.disabled = false;
            let epjsShown = 0;
            
            availableEpjsData.forEach(item => {
                const epj = item.epj;
                const storeOnly = item.storeOnly;
                const epjLocation = epjInfoMap[epj] ? epjInfoMap[epj].location : 'Unknown';
                
                // Apply zone filter
                const matchesZone = selectedZone === 'All' || epjLocation === selectedZone;
                
                if (matchesZone) {
                    const option = document.createElement('option');
                    option.value = epj;
                    option.textContent = epj + (storeOnly ? ' üè™ (Store Delivery)' : '');
                    epjSelect.appendChild(option);
                    epjsShown++;
                }
            });

            if (epjsShown === 0) {
                const option = document.createElement('option');
                option.textContent = 'No available EPJs in this zone';
                option.disabled = true;
                epjSelect.appendChild(option);
            }
            
            epjSelect.value = ''; 
            infoDisplay.innerHTML = '<small>Select an EPJ to see its last reported status.</small>';
        }
        
        zoneFilter.addEventListener('change', updateEpjList);
        
        epjSelect.addEventListener('change', function() {
            const selectedEpj = this.value;
            if (selectedEpj && epjInfoMap[selectedEpj]) {
                const info = epjInfoMap[selectedEpj];
                const epjData = availableEpjsData.find(item => item.epj === selectedEpj);
                const storeOnlyBadge = epjData && epjData.storeOnly 
                    ? '<span class="store-only-badge">üè™ STORE DELIVERY ONLY</span>' 
                    : '';
                    
                infoDisplay.innerHTML = `<small><b>EPJ:</b> ${selectedEpj} ${storeOnlyBadge}<br><b>Last Location:</b> ${info.location || 'N/A'}<br><b>Last Reported Fault:</b> ${info.fault || 'None'}</small>`;
            } else {
                infoDisplay.innerHTML = `<small>Select an EPJ to see its last reported status.</small>`;
            }
        });

        document.getElementById('checkOutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                token: window.sessionToken,
                driverName: document.getElementById('driverName').value,
                truckNumber: document.getElementById('truckNumber').value,
                trailerNumber: document.getElementById('trailerNumber').value,
                route: document.getElementById('route').value,
                epjNumber: document.getElementById('epjNumber').value,
                faultReport: document.getElementById('faultReport').value
            };
            if (!formData.epjNumber) { alert('Please select an EPJ.'); return; }
            document.getElementById("feedback").innerText = "Processing Check-Out...";
            submitBtn.disabled = true;
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(function(error) {
                    submitBtn.disabled = false;
                    document.getElementById("feedback").innerText = '';
                    alert('Error: ' + error.message);
                })
                .processCheckOut(formData);
        });
        
        function onSuccess(message) {
             if (message.startsWith('Error:')) {
                submitBtn.disabled = false;
                document.getElementById("feedback").innerText = '';
                alert(message);
            } else {
                document.querySelector('article').innerHTML = `
                    <h2>Success!</h2>
                    <p>${message}</p>
                    <p>Returning to login screen...</p>
                `;
                setTimeout(logout, 2000);
            }
        }
    </script>
</body>
</html>