<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        main { max-width: 800px; margin: 2rem auto; }
        #epjInfoDisplay {
            padding: 0.75rem; border-radius: 0.25rem;
            background-color: var(--card-background-color); border: var(--card-border);
            margin-top: 1rem; min-height: 70px;
        }
        input[readonly] { background-color: var(--pico-muted-border-color); }
        
        /* Store delivery indicator */
        .store-only-badge {
            background: #1976d2;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Loading spinner for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 1.2em;
            height: 1.2em;
            top: 50%;
            left: 50%;
            margin-top: -0.6em;
            margin-left: -0.6em;
            border: 3px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        
        .btn-loading span {
            visibility: hidden;
        }

        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }
        
        /* Overspill styling */
        .overspill-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .overspill-toggle:hover {
            background: #ffe0b2;
        }
        
        .overspill-toggle input[type="checkbox"] {
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            margin: 0;
        }
        
        .overspill-toggle label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            color: #e65100;
        }
        
        .overspill-toggle small {
            color: #f57c00;
        }
        
        .overspill-active {
            background: #ffcc80;
            border-color: #e65100;
        }
        
        .field-optional {
            opacity: 0.6;
        }
        
        .field-optional input {
            background: var(--pico-muted-border-color);
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.75rem; z-index: 10;">
                <button class="outline" onclick="loadProfilePage()">My Profile</button>
                <button class="contrast" onclick="logout()">Logout</button>
            </div>
            
            <h2>Driver Check-Out</h2>
            <p>Welcome, <b><?!= username; ?></b>. Please confirm your details to check out an EPJ.</p>

            <form id="checkOutForm">
                <!-- Overspill Toggle -->
                <div class="overspill-toggle" id="overspillToggle">
                    <input type="checkbox" id="overspillCheckbox" name="overspill">
                    <div>
                        <label for="overspillCheckbox">Overspill / No Load Assigned</label><br>
                        <small>Check this if you don't have an assigned load yet</small>
                    </div>
                </div>
                
                <div class="grid">
                    <label>Driver Name<input type="text" id="driverName" name="driverName" value="<?!= username; ?>" readonly></label>
                    <label id="truckLabel">Truck Number<input type="text" id="truckNumber" name="truckNumber" required></label>
                </div>
                <div class="grid">
                    <label id="trailerLabel">Trailer Number<input type="text" id="trailerNumber" name="trailerNumber" required></label>
                    <label id="routeLabel">Route (Store Numbers)<input type="text" id="route" name="route" placeholder="1234 / 5678 / 9012" required></label>
                </div>
                
                <hr>

                <div id="epjSection">
                    <label for="zoneFilter">Filter by Zone</label>
                    <select id="zoneFilter" disabled>
                        <option value="All" selected>Loading zones...</option>
                    </select>

                    <label for="epjNumber">Select EPJ</label>
                    <select id="epjNumber" name="epjNumber" required disabled>
                        <option value="" disabled selected>Loading...</option>
                    </select>

                    <div id="epjInfoDisplay"><small>Loading equipment data...</small></div>
                </div>

                <label for="faultReport">Pre-Trip: Report any existing issues (optional)</label>
                <textarea id="faultReport" name="faultReport" placeholder="e.g., Fork is slightly bent, battery cover is cracked..."></textarea>
                
                <button type="submit" id="submitBtn"><span>Complete Check-Out</span></button>
                <p id="feedback" style="text-align:center; min-height:20px;">Loading equipment data...</p>
            </form>
        </article>
    </main>
    <script>
        (function() {
            // Use the parent's sessionToken - do NOT redeclare with var/let/const
            var _token = (typeof sessionToken !== 'undefined' && sessionToken) ? sessionToken : "<?= token ?>";
            var _epjInfoMap = {};
            var _availableEpjsData = []; // Stores objects with epj and storeOnly flag
            var _zoneOptionsHtml = '';

            var zoneFilter = document.getElementById('zoneFilter');
            var epjSelect = document.getElementById('epjNumber');
            var infoDisplay = document.getElementById('epjInfoDisplay');
            var submitBtn = document.getElementById('submitBtn');
            
            // Disable form until data loads
            if (submitBtn) submitBtn.disabled = true;
            if (zoneFilter) zoneFilter.disabled = true;

            // Route input auto-formatting (adds slashes after every 4 digits)
            var routeInput = document.getElementById('route');
            if (routeInput) {
                routeInput.addEventListener('input', function(e) {
                    // Don't auto-format if overspill is checked
                    var overspillCheckbox = document.getElementById('overspillCheckbox');
                    if (overspillCheckbox && overspillCheckbox.checked) return;
                    
                    var value = e.target.value;
                    // Remove all non-digits
                    var digitsOnly = value.replace(/\D/g, '');
                    // Split into groups of 4
                    var formatted = '';
                    for (var i = 0; i < digitsOnly.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formatted += ' / ';
                        }
                        formatted += digitsOnly[i];
                    }
                    e.target.value = formatted;
                });
            }
            
            // Overspill toggle functionality
            var overspillCheckbox = document.getElementById('overspillCheckbox');
            var overspillToggle = document.getElementById('overspillToggle');
            var truckInput = document.getElementById('truckNumber');
            var trailerInput = document.getElementById('trailerNumber');
            var truckLabel = document.getElementById('truckLabel');
            var trailerLabel = document.getElementById('trailerLabel');
            var routeLabel = document.getElementById('routeLabel');
            var epjSection = document.getElementById('epjSection');
            
            if (overspillCheckbox) {
                overspillCheckbox.addEventListener('change', function() {
                    var isOverspill = this.checked;
                    
                    // Toggle visual state
                    if (overspillToggle) {
                        if (isOverspill) {
                            overspillToggle.classList.add('overspill-active');
                        } else {
                            overspillToggle.classList.remove('overspill-active');
                        }
                    }
                    
                    // Update route field
                    if (routeInput) {
                        if (isOverspill) {
                            routeInput.value = 'OS / Overspill';
                            routeInput.readOnly = true;
                        } else {
                            routeInput.value = '';
                            routeInput.readOnly = false;
                            routeInput.placeholder = '1234 / 5678 / 9012';
                        }
                    }
                    
                    // Hide/show EPJ selection for overspill
                    if (epjSection) {
                        epjSection.style.display = isOverspill ? 'none' : 'block';
                    }
                    
                    // Update EPJ select required attribute
                    if (epjSelect) {
                        epjSelect.required = !isOverspill;
                    }
                    
                    // Update route label styling only
                    if (routeLabel) routeLabel.classList.toggle('field-optional', isOverspill);
                });
            }

            // Load data asynchronously
            google.script.run
                .withSuccessHandler(function(data) {
                    if (!data || !data.availableEpjs || typeof data.epjInfoMap !== 'object') {
                        var feedback = document.getElementById('feedback');
                        if (feedback) feedback.innerText = 'Error loading equipment data.';
                        if (infoDisplay) infoDisplay.innerHTML = '<small style="color:red">Could not load equipment data. Please try again or contact admin.</small>';
                        if (epjSelect) epjSelect.innerHTML = '<option disabled selected>Error loading EPJs</option>';
                        if (submitBtn) submitBtn.disabled = true;
                        return;
                    }
                    
                    // Process EPJ data - filter OUT store-only EPJs (they can only be checked out from check-in form)
                    _availableEpjsData = data.availableEpjs
                        .map(function(item) {
                            if (typeof item === 'string') {
                                return { epj: item, storeOnly: false };
                            }
                            return item;
                        })
                        .filter(function(item) {
                            return !item.storeOnly; // Exclude store-only EPJs
                        });
                    
                    _epjInfoMap = data.epjInfoMap;
                    _zoneOptionsHtml = data.zoneOptions;

                    // Populate zone filter - clear and rebuild
                    if (zoneFilter) {
                        zoneFilter.innerHTML = '<option value="All" selected>Show All Zones</option>';
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = _zoneOptionsHtml;
                        Array.from(tempDiv.querySelectorAll('option')).forEach(function(opt) {
                            zoneFilter.appendChild(opt.cloneNode(true));
                        });
                        zoneFilter.disabled = false;
                    }

                    // Enable form
                    if (submitBtn) submitBtn.disabled = false;
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = '';
                    if (infoDisplay) infoDisplay.innerHTML = '<small>Select an EPJ to see its last reported status.</small>';

                    // Initialize EPJ list
                    updateEpjList();
                })
                .withFailureHandler(function(error) {
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = 'Error loading data: ' + (error.message || 'Unknown error');
                    if (infoDisplay) infoDisplay.innerHTML = '<small style="color:red">Could not load equipment data. Please try again or contact admin.</small>';
                    if (epjSelect) epjSelect.innerHTML = '<option disabled selected>Error loading EPJs</option>';
                    if (submitBtn) submitBtn.disabled = true;
                })
                .getCheckoutFormData({token: _token});

            function updateEpjList() {
                var selectedZone = zoneFilter ? zoneFilter.value : 'All';
                if (epjSelect) {
                    epjSelect.innerHTML = ''; 
                    epjSelect.disabled = false;
                }
                var epjsShown = 0;
                
                _availableEpjsData.forEach(function(item) {
                    var epj = item.epj;
                    var epjLocation = _epjInfoMap[epj] ? _epjInfoMap[epj].location : 'Unknown';
                    
                    // Apply zone filter
                    var matchesZone = selectedZone === 'All' || epjLocation === selectedZone;
                    
                    if (matchesZone && epjSelect) {
                        var option = document.createElement('option');
                        option.value = epj;
                        option.textContent = epj;
                        epjSelect.appendChild(option);
                        epjsShown++;
                    }
                });

                if (epjsShown === 0 && epjSelect) {
                    var option = document.createElement('option');
                    option.textContent = 'No available EPJs in this zone';
                    option.disabled = true;
                    epjSelect.appendChild(option);
                }
                
                if (epjSelect) epjSelect.value = ''; 
                if (infoDisplay) infoDisplay.innerHTML = '<small>Select an EPJ to see its last reported status.</small>';
            }
            
            if (zoneFilter) {
                zoneFilter.addEventListener('change', updateEpjList);
            }
            
            if (epjSelect) {
                epjSelect.addEventListener('change', function() {
                    var selectedEpj = this.value;
                    if (selectedEpj && _epjInfoMap[selectedEpj]) {
                        var info = _epjInfoMap[selectedEpj];
                        var epjData = _availableEpjsData.find(function(item) { return item.epj === selectedEpj; });
                        var storeOnlyBadge = epjData && epjData.storeOnly 
                            ? '<span class="store-only-badge">üè™ STORE DELIVERY ONLY</span>' 
                            : '';
                            
                        if (infoDisplay) {
                            infoDisplay.innerHTML = '<small><b>EPJ:</b> ' + selectedEpj + ' ' + storeOnlyBadge + '<br><b>Last Location:</b> ' + (info.location || 'N/A') + '<br><b>Last Reported Fault:</b> ' + (info.fault || 'None') + '</small>';
                        }
                    } else if (infoDisplay) {
                        infoDisplay.innerHTML = '<small>Select an EPJ to see its last reported status.</small>';
                    }
                });
            }

            var checkOutForm = document.getElementById('checkOutForm');
            if (checkOutForm) {
                checkOutForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var isOverspill = overspillCheckbox && overspillCheckbox.checked;
                    var formData = {
                        token: _token,
                        driverName: document.getElementById('driverName') ? document.getElementById('driverName').value : '',
                        truckNumber: document.getElementById('truckNumber') ? document.getElementById('truckNumber').value : '',
                        trailerNumber: document.getElementById('trailerNumber') ? document.getElementById('trailerNumber').value : '',
                        route: document.getElementById('route') ? document.getElementById('route').value : '',
                        epjNumber: isOverspill ? '' : (epjSelect ? epjSelect.value : ''),
                        faultReport: document.getElementById('faultReport') ? document.getElementById('faultReport').value : '',
                        isOverspill: isOverspill
                    };
                    // Only require EPJ if not overspill
                    if (!isOverspill && !formData.epjNumber) { alert('Please select an EPJ.'); return; }
                    
                    // Show loading state on button
                    if (submitBtn) {
                        submitBtn.classList.add('btn-loading');
                        submitBtn.disabled = true;
                    }
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = '';
                    
                    google.script.run
                        .withSuccessHandler(onCheckoutSuccess)
                        .withFailureHandler(function(error) {
                            if (submitBtn) {
                                submitBtn.classList.remove('btn-loading');
                                submitBtn.disabled = false;
                            }
                            if (feedback) feedback.innerText = '';
                            alert('Error: ' + (error.message || 'Unknown error'));
                        })
                        .processCheckOut(formData);
                });
            }
            
            function onCheckoutSuccess(message) {
                if (message && message.startsWith && message.startsWith('Error:')) {
                    if (submitBtn) {
                        submitBtn.classList.remove('btn-loading');
                        submitBtn.disabled = false;
                    }
                    var feedback = document.getElementById('feedback');
                    if (feedback) feedback.innerText = '';
                    alert(message);
                } else {
                    var article = document.querySelector('article');
                    if (article) {
                        article.innerHTML = 
                            '<h2>Success!</h2>' +
                            '<p>' + message + '</p>' +
                            '<p>Returning to login screen...</p>';
                    }
                    setTimeout(function() {
                        if (typeof logout === 'function') logout();
                    }, 2000);
                }
            }
            
            // Inactivity timeout - return to login after 2 minutes of no activity
            var inactivityTimeout;
            var INACTIVITY_LIMIT = 2 * 60 * 1000; // 2 minutes in milliseconds
            
            function resetInactivityTimer() {
                clearTimeout(inactivityTimeout);
                inactivityTimeout = setTimeout(function() {
                    if (typeof logout === 'function') {
                        logout();
                    }
                }, INACTIVITY_LIMIT);
            }
            
            // Track user activity
            ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'].forEach(function(event) {
                document.addEventListener(event, resetInactivityTimer, { passive: true });
            });
            
            // Start the inactivity timer
            resetInactivityTimer();
        })();
    </script>
</body>
</html>