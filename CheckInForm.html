<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style> 
        main { max-width: 800px; margin: 2rem auto; }
        
        /* Make checkboxes look standard and larger */
        input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            accent-color: var(--pico-color-green-500, #4caf50);
            margin-right: 0.5em;
            vertical-align: middle;
        }
        
        /* Store delivery indicator */
        .store-only-note {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }
        
        .store-badge {
            background: #1976d2;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.75rem; z-index: 10;">
                <button class="outline" onclick="loadProfilePage()">My Profile</button>
                <button class="contrast" onclick="logout()">Logout</button>
            </div>
            
            <h2>Driver Check-In</h2>
            <p>Welcome back, <b><?!= username; ?></b></p>
            <p>You currently have <b>EPJ <?!= tripInfo.epj; ?></b> checked out.</p>
            
            <div id="storeOnlyNotice" style="display: none;" class="store-only-note">
                üè™ <strong>Store Delivery EPJ:</strong> This EPJ is designated for store deliveries only.
            </div>

            <label for="checkInZone">Final Location of EPJ</label>
            <select id="checkInZone" disabled>
                <option>Loading zones...</option>
            </select>

            <label for="faultReport">Post-Trip: Report any new issues (optional)</label>
            <textarea id="faultReport" placeholder="e.g., Battery died quickly, makes a grinding noise..."></textarea>

            <label style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                <input type="checkbox" id="pluggedInConfirmation" name="confirm">
                I confirm that the EPJ is plugged in and ready for the next driver.
            </label>

            <button id="checkInBtn" onclick="checkIn()" disabled>Complete Check-In</button>
            <p id="feedback" style="text-align:center; min-height:20px;">Loading...</p>
        </article>
    </main>
    <script>
        // Robust session token management for kiosk reliability
        function getSessionToken() {
            let token = window.sessionToken || localStorage.getItem('sessionToken') || (window.parent && window.parent.sessionToken) || "<?= token ?>";
            if (!token || token === 'undefined' || token === 'null') {
                // Redirect to login if token is missing/invalid
                window.location.href = 'Index.html'; // Change to your login page if needed
                return null;
            }
            window.sessionToken = token;
            localStorage.setItem('sessionToken', token);
            return token;
        }
        // Use window.sessionToken only, do not redeclare
        var currentEpj = "<?!= tripInfo.epj; ?>";
        
        // Load zone options and EPJ details asynchronously
        function loadCheckinData() {
            var token = getSessionToken();
            if (!token) return;
            google.script.run
                .withSuccessHandler(function(data) {
                    const checkInZone = document.getElementById('checkInZone');
                    checkInZone.innerHTML = data.zoneOptions;
                    checkInZone.disabled = false;
                    document.getElementById('checkInBtn').disabled = false;
                    document.getElementById('feedback').innerText = '';
                    // Check if current EPJ is store-only and show notice
                    if (data.currentEpjIsStoreOnly) {
                        document.getElementById('storeOnlyNotice').style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    // If session error, redirect to login
                    if (error && error.message && error.message.includes('Invalid session')) {
                        window.location.href = 'Index.html';
                    } else {
                        document.getElementById('feedback').innerText = 'Error loading zones: ' + error.message;
                    }
                })
                .getCheckinFormData({token: token, epj: currentEpj});
        }
        loadCheckinData();
        
        function checkIn() {
            const confirmationCheckbox = document.getElementById('pluggedInConfirmation');
            const checkInBtn = document.getElementById('checkInBtn');
            var token = getSessionToken();
            if (!token) return;
            if (!confirmationCheckbox.checked) {
                alert('You must confirm the EPJ is plugged in before checking it in.');
                return;
            }
            const checkInZone = document.getElementById('checkInZone').value;
            if (!checkInZone) {
                alert('Please select the final location of the EPJ.');
                return;
            }
            const faultReport = document.getElementById('faultReport').value;
            document.getElementById("feedback").innerText = "Processing Check-In...";
            checkInBtn.disabled = true;
            google.script.run.withSuccessHandler(onSuccess).processCheckIn({
                token: token, 
                checkInZone: checkInZone, 
                faultReport: faultReport,
                pluggedIn: confirmationCheckbox.checked
            });
        }
        
        function onSuccess(message) {
            const checkInBtn = document.getElementById('checkInBtn');
            if (message.startsWith('Error:')) {
                document.getElementById("feedback").innerText = '';
                checkInBtn.disabled = false;
                alert(message);
            } else {
                document.querySelector('article').innerHTML = `
                    <h2>Success!</h2>
                    <p>${message}</p>
                    <p>Returning to login screen...</p>
                `;
                setTimeout(logout, 2000);
            }
        }
    </script>
</body>
</html>