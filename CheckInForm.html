<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style> 
        main { max-width: 800px; margin: 2rem auto; }
        
        /* Make checkboxes look standard and larger */
        input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            accent-color: var(--pico-color-green-500, #4caf50);
            margin-right: 0.5em;
            vertical-align: middle;
        }
        
        /* Loading spinner for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 1.2em;
            height: 1.2em;
            top: 50%;
            left: 50%;
            margin-top: -0.6em;
            margin-left: -0.6em;
            border: 3px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        
        .btn-loading span {
            visibility: hidden;
        }
        
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }
        
        /* EPJ Swap Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: var(--pico-background-color, #fff);
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: auto;
        }
        .modal-close:hover {
            color: var(--pico-primary);
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.75rem; z-index: 10;">
                <button class="outline" onclick="loadProfilePage()">My Profile</button>
                <button class="contrast" onclick="logout()">Logout</button>
            </div>
            
            <h2>Driver Check-In</h2>
            <p>Welcome back, <b><?!= username; ?></b></p>
            <p>You currently have <b>EPJ <?!= currentEpj; ?></b> checked out.</p>
            
            <button id="changeEpjBtn" class="outline secondary" style="margin-bottom: 1rem;" onclick="openEpjSwapModal()">
                ðŸ”„ Need a Different EPJ?
            </button>
            
            <label for="checkInZone">Final Location of EPJ</label>
            <select id="checkInZone" disabled>
                <option>Loading zones...</option>
            </select>

            <label for="faultReport">Post-Trip: Report any new issues (optional)</label>
            <textarea id="faultReport" placeholder="e.g., Battery died quickly, makes a grinding noise..."></textarea>

            <label style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                <input type="checkbox" id="pluggedInConfirmation" name="confirm">
                I confirm that the EPJ is plugged in and ready for the next driver.
            </label>


            <button id="checkInBtn" onclick="doCheckIn()" disabled><span>Complete Check-In</span></button>
            <p id="feedback" style="text-align:center; min-height:20px;">Loading...</p>
        </article>
        
        <!-- EPJ Swap Modal -->
        <div id="epjSwapModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Change Your EPJ</h3>
                    <button class="modal-close" onclick="closeEpjSwapModal()">&times;</button>
                </div>
                
                <p style="margin-bottom: 1rem;">Current EPJ: <strong><?!= currentEpj; ?></strong></p>
                
                <label for="swapNewEpj">Select New EPJ</label>
                <select id="swapNewEpj">
                    <option value="" disabled selected>Loading available EPJs...</option>
                </select>
                
                <label for="swapCurrentLocation">Where is your current EPJ?</label>
                <select id="swapCurrentLocation">
                    <option value="">Loading zones...</option>
                </select>
                
                <label for="swapIssueReport">Issue with current EPJ? (optional)</label>
                <textarea id="swapIssueReport" placeholder="e.g., Battery died, forks not lifting properly..."></textarea>
                <small style="display:block; margin-top:-0.5rem; margin-bottom:1rem; color:var(--pico-muted-color);">If you report an issue, the EPJ will be flagged for maintenance.</small>
                
                <div class="grid">
                    <button class="secondary" onclick="closeEpjSwapModal()">Cancel</button>
                    <button id="swapConfirmBtn" onclick="confirmEpjSwap()"><span>Confirm Swap</span></button>
                </div>
                
                <p id="swapFeedback" style="text-align:center; min-height:20px; margin-top:1rem;"></p>
            </div>
        </div>
    </main>
    <script>
        (function() {
            // Use the parent's sessionToken - do NOT redeclare with var/let/const
            var _token = (typeof sessionToken !== 'undefined' && sessionToken) ? sessionToken : "<?= token ?>";
            var _currentEpj = "<?!= currentEpj; ?>";
            
            // Load zone options and EPJ details asynchronously
            function loadCheckinData() {
                google.script.run
                    .withSuccessHandler(function(data) {
                        var checkInZone = document.getElementById('checkInZone');
                        if (checkInZone) {
                            checkInZone.innerHTML = data.zoneOptions;
                            checkInZone.disabled = false;
                        }
                        var checkInBtn = document.getElementById('checkInBtn');
                        if (checkInBtn) checkInBtn.disabled = false;
                        var feedback = document.getElementById('feedback');
                        if (feedback) feedback.innerText = '';
                    })
                    .withFailureHandler(function(error) {
                        var feedback = document.getElementById('feedback');
                        if (feedback) {
                            feedback.innerText = 'Error loading zones: ' + (error.message || 'Unknown error');
                        }
                    })
                    .getCheckinFormData({token: _token, epj: _currentEpj});
            }
            
            // Check-in function - exposed to global scope for onclick
            window.doCheckIn = function() {
                var confirmationCheckbox = document.getElementById('pluggedInConfirmation');
                var checkInBtn = document.getElementById('checkInBtn');
                
                if (!confirmationCheckbox || !confirmationCheckbox.checked) {
                    alert('You must confirm the EPJ is plugged in before checking it in.');
                    return;
                }
                
                var checkInZoneEl = document.getElementById('checkInZone');
                var checkInZone = checkInZoneEl ? checkInZoneEl.value : '';
                if (!checkInZone) {
                    alert('Please select the final location of the EPJ.');
                    return;
                }
                
                var faultReportEl = document.getElementById('faultReport');
                var faultReport = faultReportEl ? faultReportEl.value : '';
                
                // Show loading state on button
                if (checkInBtn) {
                    checkInBtn.classList.add('btn-loading');
                    checkInBtn.disabled = true;
                }
                var feedback = document.getElementById('feedback');
                if (feedback) feedback.innerText = '';
                
                google.script.run
                    .withSuccessHandler(function(message) {
                        if (message && message.startsWith && message.startsWith('Error:')) {
                            if (feedback) feedback.innerText = '';
                            if (checkInBtn) {
                                checkInBtn.classList.remove('btn-loading');
                                checkInBtn.disabled = false;
                            }
                            alert(message);
                        } else {
                            var article = document.querySelector('article');
                            if (article) {
                                article.innerHTML = 
                                    '<h2>Success!</h2>' +
                                    '<p>' + message + '</p>' +
                                    '<p>Returning to login screen...</p>';
                            }
                            setTimeout(function() {
                                if (typeof logout === 'function') logout();
                            }, 2000);
                        }
                    })
                    .withFailureHandler(function(error) {
                        if (feedback) feedback.innerText = '';
                        if (checkInBtn) {
                            checkInBtn.classList.remove('btn-loading');
                            checkInBtn.disabled = false;
                        }
                        alert('Error: ' + (error.message || 'Unknown error'));
                    })
                    .processCheckIn({
                        token: _token, 
                        checkInZone: checkInZone, 
                        faultReport: faultReport,
                        pluggedIn: true
                    });
            };
            
            // Initialize
            loadCheckinData();
            
            // EPJ Swap Modal Functions
            window.openEpjSwapModal = function() {
                document.getElementById('swapFeedback').textContent = '';
                document.getElementById('swapIssueReport').value = '';
                
                // Load available EPJs
                var epjSelect = document.getElementById('swapNewEpj');
                epjSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
                
                google.script.run
                    .withSuccessHandler(function(data) {
                        epjSelect.innerHTML = '<option value="" disabled selected>Select new EPJ...</option>';
                        if (data && data.availableEpjs && data.availableEpjs.length > 0) {
                            data.availableEpjs.forEach(function(item) {
                                var opt = document.createElement('option');
                                opt.value = item.epj;
                                opt.textContent = item.epj + (item.storeOnly ? ' [Store Only]' : '');
                                epjSelect.appendChild(opt);
                            });
                        } else {
                            epjSelect.innerHTML = '<option value="" disabled selected>No EPJs available</option>';
                        }
                        
                        // Also populate the zone dropdown
                        var zoneSelect = document.getElementById('swapCurrentLocation');
                        if (data && data.zoneOptions) {
                            zoneSelect.innerHTML = data.zoneOptions;
                        }
                    })
                    .withFailureHandler(function(err) {
                        epjSelect.innerHTML = '<option value="" disabled selected>Error loading EPJs</option>';
                    })
                    .getCheckoutFormData({token: _token});
                
                document.getElementById('epjSwapModal').classList.add('active');
            };
            
            window.closeEpjSwapModal = function() {
                document.getElementById('epjSwapModal').classList.remove('active');
            };
            
            window.confirmEpjSwap = function() {
                var newEpj = document.getElementById('swapNewEpj').value;
                var currentLocation = document.getElementById('swapCurrentLocation').value;
                var issueReport = document.getElementById('swapIssueReport').value;
                var feedback = document.getElementById('swapFeedback');
                var btn = document.getElementById('swapConfirmBtn');
                
                if (!newEpj) {
                    feedback.textContent = 'Please select a new EPJ.';
                    feedback.style.color = 'red';
                    return;
                }
                
                if (!currentLocation) {
                    feedback.textContent = 'Please select where your current EPJ is located.';
                    feedback.style.color = 'red';
                    return;
                }
                
                // Show loading state
                btn.classList.add('btn-loading');
                btn.disabled = true;
                feedback.textContent = 'Processing swap...';
                feedback.style.color = '';
                
                google.script.run
                    .withSuccessHandler(function(message) {
                        btn.classList.remove('btn-loading');
                        btn.disabled = false;
                        
                        if (message && message.indexOf('Error') !== -1) {
                            feedback.textContent = message;
                            feedback.style.color = 'red';
                        } else {
                            feedback.textContent = message;
                            feedback.style.color = 'green';
                            
                            // Reload the page to show new EPJ info
                            setTimeout(function() {
                                closeEpjSwapModal();
                                // Use the parent's goBackToUserView function to properly reload
                                if (typeof goBackToUserView === 'function') {
                                    goBackToUserView();
                                } else {
                                    // Fallback: reload using getUserView through loadView
                                    google.script.run
                                        .withSuccessHandler(function(html) {
                                            if (typeof loadView === 'function') {
                                                loadView(html);
                                            } else {
                                                // Last resort: update content div directly
                                                var contentDiv = document.getElementById('content');
                                                if (contentDiv) {
                                                    contentDiv.innerHTML = html;
                                                    // Re-execute scripts
                                                    var scripts = contentDiv.getElementsByTagName('script');
                                                    for (var i = 0; i < scripts.length; i++) {
                                                        var script = document.createElement('script');
                                                        script.type = 'text/javascript';
                                                        if (scripts[i].innerText) {
                                                            script.innerText = scripts[i].innerText;
                                                        }
                                                        document.body.appendChild(script).parentNode.removeChild(script);
                                                    }
                                                }
                                            }
                                        })
                                        .withFailureHandler(function() {
                                            alert('EPJ swapped successfully! Please log in again to continue.');
                                            if (typeof logout === 'function') logout();
                                        })
                                        .getUserView(_token);
                                }
                            }, 1500);
                        }
                    })
                    .withFailureHandler(function(err) {
                        btn.classList.remove('btn-loading');
                        btn.disabled = false;
                        feedback.textContent = 'Error: ' + (err.message || 'Unknown error');
                        feedback.style.color = 'red';
                    })
                    .driverSwapEpj({
                        token: _token,
                        newEpj: newEpj,
                        currentLocation: currentLocation,
                        issueReport: issueReport
                    });
            };
        })();
    </script>
</body>
</html>