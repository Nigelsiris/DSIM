<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <?!= include('SharedStyles'); ?>
    <?!= include('AppShellStyles'); ?>
    <style>
        main { max-width: 800px; margin: 2rem auto; }

        label input[type="checkbox"] {
            width: auto;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="topRightControls" class="top-controls">
        <button class="outline" onclick="loadProfilePage()">My Profile</button>
        <button class="contrast" onclick="logout()">Logout</button>
    </div>
    <main class="container">
        <article>
            
            <h2>Driver Check-In</h2>
            <p>Welcome back, <b><?!= username; ?></b></p>
            <p>You currently have <b>EPJ <?!= tripInfo.epj; ?></b> checked out.</p>

            <label for="checkInZone">Final Location of EPJ</label>
            <select id="checkInZone"><?!= zoneOptions; ?></select>

            <label for="faultReport">Post-Trip: Report any new issues (optional)</label>
            <textarea id="faultReport" placeholder="e.g., Battery died quickly, makes a grinding noise..."></textarea>

            <label style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                <input type="checkbox" id="pluggedInConfirmation" name="confirm">
                I confirm that the EPJ is plugged in and ready for the next driver.
            </label>

            <button id="checkInBtn" onclick="checkIn()">Complete Check-In</button>
            <p id="feedback" style="text-align:center; min-height:20px;"></p>
        </article>
    </main>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="assertive"></div>

    <?!= include('AppShellScript'); ?>
    <script>
        const app = AppShell.init();
        function checkIn() {
            const confirmationCheckbox = document.getElementById('pluggedInConfirmation');
            const checkInBtn = document.getElementById('checkInBtn');
            if (!confirmationCheckbox.checked) {
                app.toast('Please confirm the EPJ is plugged in.', { variant: 'error' });
                return;
            }
            const checkInZone = document.getElementById('checkInZone').value;
            if (!checkInZone) {
                app.toast('Please select the final location.', { variant: 'error' });
                return;
            }
            const faultReport = document.getElementById('faultReport').value;
            document.getElementById("feedback").innerText = "Processing Check-In...";
            checkInBtn.disabled = true;
            app.showLoading();
            google.script.run.withSuccessHandler(onSuccess).processCheckIn({
                token: sessionToken,
                checkInZone: checkInZone,
                faultReport: faultReport,
                pluggedIn: confirmationCheckbox.checked
            });
        }

        function onSuccess(message) {
            const checkInBtn = document.getElementById('checkInBtn');
            app.hideLoading();
            if (message.startsWith('Error:')) {
                document.getElementById("feedback").innerText = '';
                checkInBtn.disabled = false;
                app.toast(message, { variant: 'error' });
            } else {
                document.querySelector('article').innerHTML = `
                    <h2>Success!</h2>
                    <p>${message}</p>
                    <p>Returning to login screen...</p>
                `;
                app.toast('Check-In complete.');
                setTimeout(logout, 2000);
            }
        }
    </script>
</body>
</html>